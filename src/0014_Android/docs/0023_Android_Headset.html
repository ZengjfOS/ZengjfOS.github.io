<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>zengjf</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/login.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> 分析文档
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Android Headset</a></li>
<li><a class="reference internal" href="#id1">参考文档</a></li>
<li><a class="reference internal" href="#id2">音频策略</a></li>
<li><a class="reference internal" href="#wiredaccessorymanager">WiredAccessoryManager</a></li>
<li><a class="reference internal" href="#id3">插拔耳机自动播放音乐</a></li>
<li><a class="reference internal" href="#id4">拔耳机切到蓝牙</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">分析文档</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="android-headset">
<h1>Android Headset<a class="headerlink" href="#android-headset" title="Permalink to this headline"></a></h1>
<p>Android耳机外设</p>
</section>
<section id="id1">
<h1>参考文档<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.csdn.net/songche123/article/details/50512044">android拔掉耳机后音乐自动暂停</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/weixin_40537714/article/details/108069875">A2DP ：蓝牙耳机和有线耳机听同时连接，音频从有线耳机出来，拔掉有线耳机，音频不能自动切换到蓝牙耳机</a></p></li>
<li><p><a class="reference external" href="https://www.cnblogs.com/wen123456/p/14379165.html">Android音频架构总结</a></p></li>
</ul>
</section>
<section id="id2">
<h1>音频策略<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://www.cnblogs.com/wen123456/p/14379165.html">Android音频架构总结</a></p></li>
<li><p>音频管理策略管理音频的输入输出，它决定各种类型的声音优先送往系统哪个输出设备，或使用哪个输入设备进行采样。</p></li>
<li><p>创建AudioTrack的时候会传入一个Stream类型，根据这个类型获得strategy，然后根据strategy获得一个device。</p></li>
</ul>
</section>
<section id="wiredaccessorymanager">
<h1>WiredAccessoryManager<a class="headerlink" href="#wiredaccessorymanager" title="Permalink to this headline"></a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.csdn.net/lsn946803746/article/details/82787795">WiredAccessoryManager（有线辅助管理器）</a></p></li>
</ul>
<p>当前Android主要通过WiredAccessoryManager去监测音频外设的插入和拔出。WiredAccessoryManager开机的时候已经通过SystemServer.java间接启动并分配了一个自由的线程，一旦监测到有音频外设的操作，这线程就会进行处理。WiredAccessoryManager刚开始时通过WiredAccessoryObserver去处理外设消息。</p>
<ul>
<li><p>外设说明</p>
<ul class="simple">
<li><p>headset：  听筒mic</p>
<ul>
<li><p>headset = 听筒 + MIC = SW_HEADPHONE_INSERT + SW_MICROPHONE_INSERT，同时上报SW_HEADPHONE_INSERT和SW_MICROPHONE_INSERT, 就表示headset为了简化, 对于android系统只上报SW_MICROPHONE_INSERT也表示headset</p></li>
</ul>
</li>
<li><p>headphone：听筒没有mic</p></li>
<li><p>Lineout：  声音输出没有mic</p></li>
</ul>
</li>
<li><p>插入耳机</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">V</span> <span class="n">WiredAccessoryManager</span><span class="p">:</span> <span class="n">notifyWiredAccessoryChanged</span><span class="p">:</span> <span class="n">when</span><span class="o">=</span><span class="mi">10930484443000</span> <span class="n">bits</span><span class="o">=</span><span class="n">SW_MICROPHONE_INSERT</span> <span class="n">mask</span><span class="o">=</span><span class="mi">10</span>
<span class="n">V</span> <span class="n">WiredAccessoryManager</span><span class="p">:</span> <span class="n">newName</span><span class="o">=</span><span class="n">h2w</span> <span class="n">newState</span><span class="o">=</span><span class="mi">1</span> <span class="n">headsetState</span><span class="o">=</span><span class="mi">1</span> <span class="n">prev</span> <span class="n">headsetState</span><span class="o">=</span><span class="mi">0</span>
<span class="n">I</span> <span class="n">WiredAccessoryManager</span><span class="p">:</span> <span class="n">MSG_NEW_DEVICE_STATE</span>
<span class="n">V</span> <span class="n">WiredAccessoryManager</span><span class="p">:</span> <span class="n">headsetName</span><span class="p">:</span>  <span class="n">connected</span>
<span class="n">D</span> <span class="n">AudioManager</span><span class="p">:</span> <span class="n">setWiredDeviceConnectionState</span><span class="p">(),</span> <span class="nb">type</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span>
<span class="n">D</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioService</span><span class="p">:</span> <span class="n">setWiredDeviceConnectionState</span><span class="p">())</span> <span class="kn">from</span> <span class="nn">u</span><span class="o">/</span><span class="n">pid</span><span class="p">:</span><span class="mi">1000</span><span class="o">/</span><span class="mi">950</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">android</span>
<span class="n">D</span> <span class="n">AudioManager</span><span class="p">:</span> <span class="n">setWiredDeviceConnectionState</span><span class="p">(),</span> <span class="nb">type</span><span class="o">=-</span><span class="mi">2147483632</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span>
<span class="n">D</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioService</span><span class="p">:</span> <span class="n">setWiredDeviceConnectionState</span><span class="p">())</span> <span class="kn">from</span> <span class="nn">u</span><span class="o">/</span><span class="n">pid</span><span class="p">:</span><span class="mi">1000</span><span class="o">/</span><span class="mi">950</span><span class="p">,</span> <span class="nb">type</span><span class="o">=-</span><span class="mi">2147483632</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">android</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">handleDeviceConnection</span><span class="p">(</span><span class="n">true</span> <span class="n">dev</span><span class="p">:</span><span class="mi">4</span> <span class="n">address</span><span class="p">:</span> <span class="n">name</span><span class="p">:)</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">handleDeviceConnection</span><span class="p">(</span><span class="n">true</span> <span class="n">dev</span><span class="p">:</span><span class="mi">4</span><span class="p">[</span><span class="n">headset</span><span class="p">]</span> <span class="n">address</span><span class="p">:</span> <span class="n">name</span><span class="p">:)</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">deviceKey</span><span class="p">:</span><span class="mh">0x4</span><span class="p">:</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">deviceInfo</span><span class="p">:</span><span class="n">null</span> <span class="ow">is</span><span class="p">(</span><span class="n">already</span><span class="p">)</span><span class="n">Connected</span><span class="p">:</span><span class="n">false</span>
<span class="n">V</span> <span class="n">AudioPolicyIntefaceImpl</span><span class="p">:</span> <span class="n">setDeviceConnectionState</span><span class="p">()</span>
<span class="n">D</span> <span class="n">APM_AudioPolicyManager</span><span class="p">:</span> <span class="n">setDeviceConnectionStateInt</span><span class="p">()</span> <span class="n">device</span><span class="p">:</span> <span class="mh">0x4</span><span class="p">,</span> <span class="n">state</span> <span class="mi">1</span><span class="p">,</span> <span class="n">address</span>  <span class="n">name</span>  <span class="nb">format</span> <span class="mh">0x0</span>
<span class="n">V</span> <span class="n">AudioPolicyService</span><span class="p">:</span> <span class="n">AudioCommandThread</span><span class="p">()</span> <span class="n">adding</span> <span class="nb">set</span> <span class="n">parameter</span> <span class="n">string</span> <span class="n">connect</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">io</span> <span class="mi">0</span> <span class="p">,</span><span class="n">delay</span> <span class="mi">0</span>
<span class="n">V</span> <span class="n">AudioPolicyService</span><span class="p">:</span> <span class="n">AudioCommandThread</span><span class="p">()</span> <span class="n">processing</span> <span class="nb">set</span> <span class="n">parameters</span> <span class="n">string</span> <span class="n">connect</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">io</span> <span class="mi">0</span>
<span class="n">D</span> <span class="n">AudioSystem</span><span class="p">:</span> <span class="o">+</span><span class="n">setParameters</span><span class="p">():</span> <span class="n">connect</span><span class="o">=</span><span class="mi">4</span>
<span class="n">D</span> <span class="n">AudioALSAHardware</span><span class="p">:</span> <span class="o">+</span><span class="n">setParameters</span><span class="p">():</span> <span class="n">connect</span><span class="o">=</span><span class="mi">4</span>
<span class="n">D</span> <span class="n">AudioALSAHardwareResourceManager</span><span class="p">:</span> <span class="o">+</span><span class="n">HpImpeDanceDetect</span>
<span class="n">D</span> <span class="n">AudioALSAHardwareResourceManager</span><span class="p">:</span> <span class="o">-</span><span class="n">HpImpeDanceDetect</span> <span class="p">:</span> <span class="n">output</span> <span class="n">device</span> <span class="n">Busy</span>
<span class="n">D</span> <span class="n">AudioALSAStreamManager</span><span class="p">:</span> <span class="o">+</span><span class="n">DeviceNoneUpdate</span><span class="p">()</span>
<span class="n">D</span> <span class="n">AudioALSAStreamManager</span><span class="p">:</span> <span class="o">-</span><span class="n">DeviceNoneUpdate</span><span class="p">()</span>
<span class="n">D</span> <span class="n">AudioALSAHardware</span><span class="p">:</span> <span class="o">-</span><span class="n">setParameters</span><span class="p">():</span> <span class="n">connect</span><span class="o">=</span><span class="mi">4</span>
<span class="n">D</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="n">setOutputDevices</span><span class="p">()</span> <span class="n">mIoHandle</span> <span class="mi">13</span> <span class="n">mId</span> <span class="mi">1</span> <span class="n">device</span> <span class="mi">0000</span><span class="p">(</span><span class="mi">0002</span><span class="p">)(</span><span class="mi">1101</span><span class="n">c7f</span><span class="p">)</span> <span class="n">delayMs</span> <span class="mi">0</span> <span class="n">force</span> <span class="mi">1</span> <span class="n">size</span> <span class="mi">3</span>
<span class="n">V</span> <span class="n">AudioPolicyService</span><span class="p">:</span> <span class="n">AudioCommandThread</span><span class="p">()</span> <span class="n">adding</span> <span class="n">release</span> <span class="n">patch</span> <span class="n">delay</span> <span class="mi">0</span>
<span class="n">D</span> <span class="n">AudioALSAHardware</span><span class="p">:</span> <span class="o">+</span><span class="n">routing</span> <span class="n">releaseAudioPatch</span> <span class="n">Mixer</span><span class="o">-&gt;</span><span class="mi">2</span>
<span class="n">D</span> <span class="n">AudioALSAHardware</span><span class="p">:</span> <span class="n">handlecheck</span> <span class="n">releaseAudioPatch</span> <span class="n">remove</span> <span class="n">handle</span> <span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="n">OK</span>
<span class="n">V</span> <span class="n">AudioPolicyService</span><span class="p">:</span> <span class="n">AudioCommandThread</span><span class="p">()</span> <span class="n">processing</span> <span class="n">update</span> <span class="n">audio</span> <span class="n">patch</span> <span class="nb">list</span>
<span class="n">I</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="o">-</span><span class="n">computeGainTableCustomVolume</span> <span class="n">volume</span> <span class="mf">1.000000</span> <span class="n">stream</span> <span class="mi">12</span><span class="p">,</span> <span class="n">index</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span> <span class="mh">0x2</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mh">0x2</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span>
<span class="n">D</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="n">setOutputDevices</span><span class="p">()</span> <span class="n">mIoHandle</span> <span class="mi">21</span> <span class="n">mId</span> <span class="mi">5</span> <span class="n">device</span> <span class="mi">0000</span><span class="p">(</span><span class="mi">0002</span><span class="p">)(</span><span class="mi">000</span><span class="n">f</span><span class="p">)</span> <span class="n">delayMs</span> <span class="mi">0</span> <span class="n">force</span> <span class="mi">1</span> <span class="n">size</span> <span class="mi">3</span>
<span class="n">D</span> <span class="n">APM</span><span class="p">::</span><span class="n">AudioOutputDescriptor</span><span class="p">:</span> <span class="n">setVolume</span> <span class="n">output</span> <span class="mi">21</span> <span class="k">for</span> <span class="n">volumeSource</span> <span class="mi">1</span><span class="p">,</span> <span class="n">volume</span> <span class="o">-</span><span class="mf">21.000002</span><span class="p">,</span> <span class="n">delay</span> <span class="mi">0</span> <span class="n">stream</span><span class="o">=</span><span class="n">AUDIO_STREAM_ACCESSIBILITY</span>
<span class="n">D</span> <span class="n">APM</span><span class="p">::</span><span class="n">AudioOutputDescriptor</span><span class="p">:</span> <span class="n">setVolume</span> <span class="n">output</span> <span class="mi">21</span> <span class="k">for</span> <span class="n">volumeSource</span> <span class="mi">6</span><span class="p">,</span> <span class="n">volume</span> <span class="o">-</span><span class="mf">14.000001</span><span class="p">,</span> <span class="n">delay</span> <span class="mi">0</span> <span class="n">stream</span><span class="o">=</span><span class="n">AUDIO_STREAM_MUSIC</span>
<span class="n">D</span> <span class="n">AudioPolicyServiceCustomImpl</span><span class="p">:</span> <span class="n">AudioCommandThread</span><span class="p">()</span> <span class="n">processing</span> <span class="nb">set</span> <span class="n">volume</span> <span class="n">stream</span> <span class="mi">3</span><span class="p">,</span>                 <span class="n">volume</span> <span class="mf">0.199527</span><span class="p">,</span> <span class="n">output</span> <span class="mi">21</span>
<span class="n">I</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="o">-</span><span class="n">computeGainTableCustomVolume</span> <span class="n">volume</span> <span class="mf">1.000000</span> <span class="n">stream</span> <span class="mi">12</span><span class="p">,</span> <span class="n">index</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span> <span class="mh">0x2</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mh">0x2</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span>
<span class="n">D</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="n">setOutputDevices</span><span class="p">()</span> <span class="n">mIoHandle</span> <span class="mi">29</span> <span class="n">mId</span> <span class="mi">7</span> <span class="n">device</span> <span class="mi">0000</span><span class="p">(</span><span class="mi">10000</span><span class="p">)(</span><span class="mi">10000</span><span class="p">)</span> <span class="n">delayMs</span> <span class="mi">0</span> <span class="n">force</span> <span class="mi">1</span> <span class="n">size</span> <span class="mi">3</span>
<span class="n">I</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="o">-</span><span class="n">computeGainTableCustomVolume</span> <span class="n">volume</span> <span class="mf">1.000000</span> <span class="n">stream</span> <span class="mi">12</span><span class="p">,</span> <span class="n">index</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span> <span class="mh">0x10000</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mh">0x2</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span>
<span class="n">V</span> <span class="n">AudioPolicyService</span><span class="p">:</span> <span class="n">AudioCommandThread</span><span class="p">()</span> <span class="n">adding</span> <span class="n">update</span> <span class="n">audio</span> <span class="n">port</span> <span class="nb">list</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceBroker</span><span class="p">:</span> <span class="n">setForceUse</span><span class="p">(</span><span class="n">FOR_MEDIA</span><span class="p">,</span> <span class="n">FORCE_NO_BT_A2DP</span><span class="p">)</span> <span class="n">due</span> <span class="n">to</span> <span class="n">setBluetoothA2dpOn</span><span class="p">(</span><span class="n">false</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">u</span><span class="o">/</span><span class="n">pid</span><span class="p">:</span><span class="mi">1000</span><span class="o">/</span><span class="mi">950</span> <span class="n">src</span><span class="p">:</span><span class="n">onSetWiredDeviceConnectionState</span> <span class="n">state</span> <span class="ow">not</span> <span class="n">DISCONNEC</span>
<span class="n">V</span> <span class="n">AudioPolicyIntefaceImpl</span><span class="p">:</span> <span class="n">setForceUse</span><span class="p">()</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioService</span><span class="p">:</span> <span class="n">onAccessoryPlugMediaUnmute</span> <span class="n">newDevice</span><span class="o">=</span><span class="mi">4</span> <span class="p">[</span><span class="n">headset</span><span class="p">]</span>
<span class="n">D</span> <span class="n">APM_AudioPolicyManager</span><span class="p">:</span> <span class="n">setForceUse</span><span class="p">()</span> <span class="n">usage</span> <span class="mi">1</span><span class="p">,</span> <span class="n">config</span> <span class="mi">10</span><span class="p">,</span> <span class="n">mPhoneState</span> <span class="mi">0</span>
<span class="n">I</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="o">-</span><span class="n">computeGainTableCustomVolume</span> <span class="n">volume</span> <span class="mf">1.000000</span> <span class="n">stream</span> <span class="mi">12</span><span class="p">,</span> <span class="n">index</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span> <span class="mh">0x2</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mh">0x2</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span>
<span class="n">I</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="o">-</span><span class="n">computeGainTableCustomVolume</span> <span class="n">volume</span> <span class="mf">1.000000</span> <span class="n">stream</span> <span class="mi">12</span><span class="p">,</span> <span class="n">index</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span> <span class="mh">0x2</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mh">0x2</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span>
<span class="n">I</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="o">-</span><span class="n">computeGainTableCustomVolume</span> <span class="n">volume</span> <span class="mf">1.000000</span> <span class="n">stream</span> <span class="mi">12</span><span class="p">,</span> <span class="n">index</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span> <span class="mh">0x10000</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mh">0x2</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">sendDeviceConnectionIntent</span><span class="p">(</span><span class="n">dev</span><span class="p">:</span><span class="mh">0x4</span> <span class="n">state</span><span class="p">:</span><span class="mh">0x1</span> <span class="n">address</span><span class="p">:</span> <span class="n">name</span><span class="p">:);</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">sendDeviceConnectionIntent</span><span class="p">(</span><span class="n">dev</span><span class="p">:</span><span class="mh">0x4</span> <span class="n">state</span><span class="p">:</span><span class="mh">0x1</span><span class="p">[</span><span class="n">headset</span><span class="p">]</span> <span class="n">address</span><span class="p">:</span> <span class="n">name</span><span class="p">:);</span>
<span class="n">D</span> <span class="n">PhoneStatusBarPolicy</span><span class="p">:</span> <span class="n">updateHeadsetPlug</span> <span class="n">connected</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="n">hasMic</span><span class="p">:</span><span class="n">true</span>
<span class="n">E</span> <span class="n">WiredAccessoryManager</span><span class="p">:</span> <span class="n">setDeviceState</span><span class="p">()</span> <span class="n">No</span> <span class="n">state</span> <span class="n">change</span>
</pre></div>
</div>
<ul class="simple">
<li><p>type=4</p>
<ul>
<li><p>SW_MICROPHONE_INSERT(headset)</p></li>
</ul>
</li>
</ul>
</li>
<li><p>拔出耳机</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">V</span> <span class="n">WiredAccessoryManager</span><span class="p">:</span> <span class="n">notifyWiredAccessoryChanged</span><span class="p">:</span> <span class="n">when</span><span class="o">=</span><span class="mi">11613747966000</span> <span class="n">bits</span><span class="o">=</span> <span class="n">mask</span><span class="o">=</span><span class="mi">10</span>
<span class="n">V</span> <span class="n">WiredAccessoryManager</span><span class="p">:</span> <span class="n">newName</span><span class="o">=</span><span class="n">h2w</span> <span class="n">newState</span><span class="o">=</span><span class="mi">0</span> <span class="n">headsetState</span><span class="o">=</span><span class="mi">0</span> <span class="n">prev</span> <span class="n">headsetState</span><span class="o">=</span><span class="mi">1</span>
<span class="n">I</span> <span class="n">WiredAccessoryManager</span><span class="p">:</span> <span class="n">MSG_NEW_DEVICE_STATE</span>
<span class="n">V</span> <span class="n">WiredAccessoryManager</span><span class="p">:</span> <span class="n">headsetName</span><span class="p">:</span>  <span class="n">disconnected</span>
<span class="n">D</span> <span class="n">AudioManager</span><span class="p">:</span> <span class="n">setWiredDeviceConnectionState</span><span class="p">(),</span> <span class="nb">type</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span>
<span class="n">D</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioService</span><span class="p">:</span> <span class="n">setWiredDeviceConnectionState</span><span class="p">())</span> <span class="kn">from</span> <span class="nn">u</span><span class="o">/</span><span class="n">pid</span><span class="p">:</span><span class="mi">1000</span><span class="o">/</span><span class="mi">950</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">android</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">dropping</span> <span class="n">ACTION_AUDIO_BECOMING_NOISY</span>
<span class="n">D</span> <span class="n">MediaSessionService</span><span class="p">:</span> <span class="n">dispatchMediaKeyEvent</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">com</span><span class="o">.</span><span class="n">android</span><span class="o">.</span><span class="n">settings</span> <span class="n">pid</span><span class="o">=</span><span class="mi">2104</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">asSystem</span><span class="o">=</span><span class="n">true</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="n">KeyEvent</span> <span class="p">{</span> <span class="n">action</span><span class="o">=</span><span class="n">ACTION_UP</span><span class="p">,</span> <span class="n">keyCode</span><span class="o">=</span><span class="n">KEYCODE_MEDIA_PLAY_PAUSE</span>
<span class="n">ags</span><span class="o">=</span><span class="mh">0x8</span><span class="p">,</span> <span class="n">repeatCount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">eventTime</span><span class="o">=</span><span class="mi">11613748</span><span class="p">,</span> <span class="n">downTime</span><span class="o">=</span><span class="mi">11613700</span><span class="p">,</span> <span class="n">deviceId</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="mh">0x101</span><span class="p">,</span> <span class="n">displayId</span><span class="o">=-</span><span class="mi">1</span> <span class="p">}</span>
<span class="n">D</span> <span class="n">AudioManager</span><span class="p">:</span> <span class="n">setWiredDeviceConnectionState</span><span class="p">(),</span> <span class="nb">type</span><span class="o">=-</span><span class="mi">2147483632</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span>
<span class="n">D</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioService</span><span class="p">:</span> <span class="n">setWiredDeviceConnectionState</span><span class="p">())</span> <span class="kn">from</span> <span class="nn">u</span><span class="o">/</span><span class="n">pid</span><span class="p">:</span><span class="mi">1000</span><span class="o">/</span><span class="mi">950</span><span class="p">,</span> <span class="nb">type</span><span class="o">=-</span><span class="mi">2147483632</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">android</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceBroker</span><span class="p">:</span> <span class="n">setForceUse</span><span class="p">(</span><span class="n">FOR_MEDIA</span><span class="p">,</span> <span class="n">FORCE_NONE</span><span class="p">)</span> <span class="n">due</span> <span class="n">to</span> <span class="n">setBluetoothA2dpOn</span><span class="p">(</span><span class="n">true</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">u</span><span class="o">/</span><span class="n">pid</span><span class="p">:</span><span class="mi">1000</span><span class="o">/</span><span class="mi">950</span> <span class="n">src</span><span class="p">:</span><span class="n">onSetWiredDeviceConnectionState</span> <span class="n">state</span> <span class="n">DISCONNECTED</span>
<span class="n">V</span> <span class="n">AudioPolicyIntefaceImpl</span><span class="p">:</span> <span class="n">setForceUse</span><span class="p">()</span>
<span class="n">D</span> <span class="n">APM_AudioPolicyManager</span><span class="p">:</span> <span class="n">setForceUse</span><span class="p">()</span> <span class="n">usage</span> <span class="mi">1</span><span class="p">,</span> <span class="n">config</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mPhoneState</span> <span class="mi">0</span>
<span class="n">I</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="o">-</span><span class="n">computeGainTableCustomVolume</span> <span class="n">volume</span> <span class="mf">1.000000</span> <span class="n">stream</span> <span class="mi">12</span><span class="p">,</span> <span class="n">index</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span> <span class="mh">0x2</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mh">0x2</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span>
<span class="n">I</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="o">-</span><span class="n">computeGainTableCustomVolume</span> <span class="n">volume</span> <span class="mf">1.000000</span> <span class="n">stream</span> <span class="mi">12</span><span class="p">,</span> <span class="n">index</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span> <span class="mh">0x2</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mh">0x2</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span>
<span class="n">I</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="o">-</span><span class="n">computeGainTableCustomVolume</span> <span class="n">volume</span> <span class="mf">1.000000</span> <span class="n">stream</span> <span class="mi">12</span><span class="p">,</span> <span class="n">index</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span> <span class="mh">0x10000</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mh">0x2</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">handleDeviceConnection</span><span class="p">(</span><span class="n">false</span> <span class="n">dev</span><span class="p">:</span><span class="mi">4</span> <span class="n">address</span><span class="p">:</span> <span class="n">name</span><span class="p">:)</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">handleDeviceConnection</span><span class="p">(</span><span class="n">false</span> <span class="n">dev</span><span class="p">:</span><span class="mi">4</span><span class="p">[</span><span class="n">headset</span><span class="p">]</span> <span class="n">address</span><span class="p">:</span> <span class="n">name</span><span class="p">:)</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">deviceKey</span><span class="p">:</span><span class="mh">0x4</span><span class="p">:</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">deviceInfo</span><span class="p">:[</span><span class="n">DeviceInfo</span><span class="p">:</span> <span class="nb">type</span><span class="p">:</span><span class="mh">0x4</span> <span class="n">name</span><span class="p">:</span> <span class="n">addr</span><span class="p">:</span> <span class="n">codec</span><span class="p">:</span> <span class="mi">0</span><span class="p">]</span> <span class="ow">is</span><span class="p">(</span><span class="n">already</span><span class="p">)</span><span class="n">Connected</span><span class="p">:</span><span class="n">true</span>
<span class="n">V</span> <span class="n">AudioPolicyIntefaceImpl</span><span class="p">:</span> <span class="n">setDeviceConnectionState</span><span class="p">()</span>
<span class="n">D</span> <span class="n">APM_AudioPolicyManager</span><span class="p">:</span> <span class="n">setDeviceConnectionStateInt</span><span class="p">()</span> <span class="n">device</span><span class="p">:</span> <span class="mh">0x4</span><span class="p">,</span> <span class="n">state</span> <span class="mi">0</span><span class="p">,</span> <span class="n">address</span>  <span class="n">name</span>  <span class="nb">format</span> <span class="mh">0x0</span>
<span class="n">V</span> <span class="n">AudioPolicyService</span><span class="p">:</span> <span class="n">AudioCommandThread</span><span class="p">()</span> <span class="n">adding</span> <span class="nb">set</span> <span class="n">parameter</span> <span class="n">string</span> <span class="n">disconnect</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">io</span> <span class="mi">0</span> <span class="p">,</span><span class="n">delay</span> <span class="mi">0</span>
<span class="n">V</span> <span class="n">AudioPolicyService</span><span class="p">:</span> <span class="n">AudioCommandThread</span><span class="p">()</span> <span class="n">processing</span> <span class="nb">set</span> <span class="n">parameters</span> <span class="n">string</span> <span class="n">disconnect</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">io</span> <span class="mi">0</span>
<span class="n">D</span> <span class="n">AudioSystem</span><span class="p">:</span> <span class="o">+</span><span class="n">setParameters</span><span class="p">():</span> <span class="n">disconnect</span><span class="o">=</span><span class="mi">4</span>
<span class="n">D</span> <span class="n">AudioALSAHardware</span><span class="p">:</span> <span class="o">+</span><span class="n">setParameters</span><span class="p">():</span> <span class="n">disconnect</span><span class="o">=</span><span class="mi">4</span>
<span class="n">D</span> <span class="n">AudioALSAStreamManager</span><span class="p">:</span> <span class="o">+</span><span class="n">DeviceNoneUpdate</span><span class="p">()</span>
<span class="n">D</span> <span class="n">AudioALSAStreamManager</span><span class="p">:</span> <span class="o">-</span><span class="n">DeviceNoneUpdate</span><span class="p">()</span>
<span class="n">D</span> <span class="n">AudioALSAHardware</span><span class="p">:</span> <span class="o">-</span><span class="n">setParameters</span><span class="p">():</span> <span class="n">disconnect</span><span class="o">=</span><span class="mi">4</span>
<span class="n">D</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="n">setOutputDevices</span><span class="p">()</span> <span class="n">mIoHandle</span> <span class="mi">13</span> <span class="n">mId</span> <span class="mi">1</span> <span class="n">device</span> <span class="mi">0000</span><span class="p">(</span><span class="mi">0002</span><span class="p">)(</span><span class="mi">1101</span><span class="n">c7f</span><span class="p">)</span> <span class="n">delayMs</span> <span class="mi">0</span> <span class="n">force</span> <span class="mi">1</span> <span class="n">size</span> <span class="mi">3</span>
<span class="n">I</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="o">-</span><span class="n">computeGainTableCustomVolume</span> <span class="n">volume</span> <span class="mf">1.000000</span> <span class="n">stream</span> <span class="mi">12</span><span class="p">,</span> <span class="n">index</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span> <span class="mh">0x2</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mh">0x2</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span>
<span class="n">D</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="n">setOutputDevices</span><span class="p">()</span> <span class="n">mIoHandle</span> <span class="mi">21</span> <span class="n">mId</span> <span class="mi">5</span> <span class="n">device</span> <span class="mi">0000</span><span class="p">(</span><span class="mi">0002</span><span class="p">)(</span><span class="mi">000</span><span class="n">f</span><span class="p">)</span> <span class="n">delayMs</span> <span class="mi">0</span> <span class="n">force</span> <span class="mi">1</span> <span class="n">size</span> <span class="mi">3</span>
<span class="n">I</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="o">-</span><span class="n">computeGainTableCustomVolume</span> <span class="n">volume</span> <span class="mf">1.000000</span> <span class="n">stream</span> <span class="mi">12</span><span class="p">,</span> <span class="n">index</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span> <span class="mh">0x2</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mh">0x2</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span>
<span class="n">D</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="n">setOutputDevices</span><span class="p">()</span> <span class="n">mIoHandle</span> <span class="mi">29</span> <span class="n">mId</span> <span class="mi">7</span> <span class="n">device</span> <span class="mi">0000</span><span class="p">(</span><span class="mi">10000</span><span class="p">)(</span><span class="mi">10000</span><span class="p">)</span> <span class="n">delayMs</span> <span class="mi">0</span> <span class="n">force</span> <span class="mi">1</span> <span class="n">size</span> <span class="mi">3</span>
<span class="n">I</span> <span class="n">AudioPolicyManagerCustomImpl</span><span class="p">:</span> <span class="o">-</span><span class="n">computeGainTableCustomVolume</span> <span class="n">volume</span> <span class="mf">1.000000</span> <span class="n">stream</span> <span class="mi">12</span><span class="p">,</span> <span class="n">index</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span> <span class="mh">0x10000</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mh">0x2</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span>
<span class="n">V</span> <span class="n">AudioPolicyService</span><span class="p">:</span> <span class="n">AudioCommandThread</span><span class="p">()</span> <span class="n">adding</span> <span class="n">update</span> <span class="n">audio</span> <span class="n">port</span> <span class="nb">list</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">sendDeviceConnectionIntent</span><span class="p">(</span><span class="n">dev</span><span class="p">:</span><span class="mh">0x4</span> <span class="n">state</span><span class="p">:</span><span class="mh">0x0</span> <span class="n">address</span><span class="p">:</span> <span class="n">name</span><span class="p">:);</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">sendDeviceConnectionIntent</span><span class="p">(</span><span class="n">dev</span><span class="p">:</span><span class="mh">0x4</span> <span class="n">state</span><span class="p">:</span><span class="mh">0x0</span><span class="p">[</span><span class="n">headset</span><span class="p">]</span> <span class="n">address</span><span class="p">:</span> <span class="n">name</span><span class="p">:);</span>
<span class="n">D</span> <span class="n">PhoneStatusBarPolicy</span><span class="p">:</span> <span class="n">updateHeadsetPlug</span> <span class="n">connected</span><span class="p">:</span><span class="n">false</span><span class="p">,</span><span class="n">hasMic</span><span class="p">:</span><span class="n">true</span>
<span class="n">I</span> <span class="n">hwcomposer</span><span class="p">:</span> <span class="p">[</span><span class="n">HWC</span><span class="p">]</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="n">displayGetActiveConfig</span> <span class="n">config</span><span class="p">:</span><span class="mi">0</span>
<span class="n">E</span> <span class="n">WiredAccessoryManager</span><span class="p">:</span> <span class="n">setDeviceState</span><span class="p">()</span> <span class="n">No</span> <span class="n">state</span> <span class="n">change</span>
<span class="n">I</span> <span class="n">chatty</span>  <span class="p">:</span> <span class="n">uid</span><span class="o">=</span><span class="mi">1000</span> <span class="n">system_server</span> <span class="n">identical</span> <span class="mi">3</span> <span class="n">lines</span>
<span class="n">E</span> <span class="n">WiredAccessoryManager</span><span class="p">:</span> <span class="n">setDeviceState</span><span class="p">()</span> <span class="n">No</span> <span class="n">state</span> <span class="n">change</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">handleDeviceConnection</span><span class="p">(</span><span class="n">false</span> <span class="n">dev</span><span class="p">:</span><span class="mi">80000010</span> <span class="n">address</span><span class="p">:</span> <span class="n">name</span><span class="p">:)</span>
<span class="n">I</span> <span class="n">Telecom</span><span class="o">-</span><span class="n">WiredHeadsetManager</span><span class="p">:</span> <span class="n">ACTION_HEADSET_PLUG</span> <span class="n">event</span><span class="p">,</span> <span class="n">plugged</span> <span class="ow">in</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span> <span class="p">:</span> <span class="n">WHC</span><span class="o">.</span><span class="n">oADR</span><span class="nd">@wgg</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">handleDeviceConnection</span><span class="p">(</span><span class="n">false</span> <span class="n">dev</span><span class="p">:</span><span class="mi">80000010</span><span class="p">[</span><span class="n">headset</span><span class="p">]</span> <span class="n">address</span><span class="p">:</span> <span class="n">name</span><span class="p">:)</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">deviceKey</span><span class="p">:</span><span class="mh">0x80000010</span><span class="p">:</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">deviceInfo</span><span class="p">:[</span><span class="n">DeviceInfo</span><span class="p">:</span> <span class="nb">type</span><span class="p">:</span><span class="mh">0x80000010</span> <span class="n">name</span><span class="p">:</span> <span class="n">addr</span><span class="p">:</span> <span class="n">codec</span><span class="p">:</span> <span class="mi">0</span><span class="p">]</span> <span class="ow">is</span><span class="p">(</span><span class="n">already</span><span class="p">)</span><span class="n">Connected</span><span class="p">:</span><span class="n">true</span>
<span class="n">D</span> <span class="n">MediaRouter</span><span class="p">:</span> <span class="n">Dispatching</span> <span class="n">route</span> <span class="n">change</span><span class="p">:</span> <span class="n">RouteInfo</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">Phone</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">RouteCategory</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">System</span> <span class="n">types</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIO</span> <span class="n">ROUTE_TYPE_LIV</span>
<span class="n">portedTypes</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIO</span> <span class="n">ROUTE_TYPE_LIVE_VIDEO</span> <span class="p">,</span> <span class="n">presentationDisplay</span><span class="o">=</span><span class="n">null</span> <span class="p">}</span>
<span class="n">V</span> <span class="n">AudioPolicyIntefaceImpl</span><span class="p">:</span> <span class="n">setDeviceConnectionState</span><span class="p">()</span>
<span class="n">D</span> <span class="n">MediaRouter</span><span class="p">:</span> <span class="n">dispatchRouteChanged</span> <span class="n">oldVisibility</span><span class="p">:</span> <span class="n">falsenewVisibility</span><span class="p">:</span> <span class="n">false</span>
<span class="n">D</span> <span class="n">APM_AudioPolicyManager</span><span class="p">:</span> <span class="n">setDeviceConnectionStateInt</span><span class="p">()</span> <span class="n">device</span><span class="p">:</span> <span class="mh">0x80000010</span><span class="p">,</span> <span class="n">state</span> <span class="mi">0</span><span class="p">,</span> <span class="n">address</span>  <span class="n">name</span>  <span class="nb">format</span> <span class="mh">0x0</span>
<span class="n">V</span> <span class="n">AudioPolicyService</span><span class="p">:</span> <span class="n">AudioCommandThread</span><span class="p">()</span> <span class="n">adding</span> <span class="nb">set</span> <span class="n">parameter</span> <span class="n">string</span> <span class="n">disconnect</span><span class="o">=-</span><span class="mi">2147483632</span><span class="p">,</span> <span class="n">io</span> <span class="mi">0</span> <span class="p">,</span><span class="n">delay</span> <span class="mi">0</span>
<span class="n">V</span> <span class="n">AudioPolicyService</span><span class="p">:</span> <span class="n">AudioCommandThread</span><span class="p">()</span> <span class="n">processing</span> <span class="nb">set</span> <span class="n">parameters</span> <span class="n">string</span> <span class="n">disconnect</span><span class="o">=-</span><span class="mi">2147483632</span><span class="p">,</span> <span class="n">io</span> <span class="mi">0</span>
<span class="n">D</span> <span class="n">AudioSystem</span><span class="p">:</span> <span class="o">+</span><span class="n">setParameters</span><span class="p">():</span> <span class="n">disconnect</span><span class="o">=-</span><span class="mi">2147483632</span>
<span class="n">D</span> <span class="n">AudioALSAHardware</span><span class="p">:</span> <span class="o">+</span><span class="n">setParameters</span><span class="p">():</span> <span class="n">disconnect</span><span class="o">=-</span><span class="mi">2147483632</span>
<span class="n">D</span> <span class="n">AudioALSAHardware</span><span class="p">:</span> <span class="o">-</span><span class="n">setParameters</span><span class="p">():</span> <span class="n">disconnect</span><span class="o">=-</span><span class="mi">2147483632</span>
<span class="n">V</span> <span class="n">AudioPolicyService</span><span class="p">:</span> <span class="n">AudioCommandThread</span><span class="p">()</span> <span class="n">adding</span> <span class="n">update</span> <span class="n">audio</span> <span class="n">port</span> <span class="nb">list</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">sendDeviceConnectionIntent</span><span class="p">(</span><span class="n">dev</span><span class="p">:</span><span class="mh">0x80000010</span> <span class="n">state</span><span class="p">:</span><span class="mh">0x0</span> <span class="n">address</span><span class="p">:</span> <span class="n">name</span><span class="p">:);</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">sendDeviceConnectionIntent</span><span class="p">(</span><span class="n">dev</span><span class="p">:</span><span class="mh">0x80000010</span> <span class="n">state</span><span class="p">:</span><span class="mh">0x0</span><span class="p">[</span><span class="n">headset</span><span class="p">]</span> <span class="n">address</span><span class="p">:</span> <span class="n">name</span><span class="p">:);</span>
<span class="n">E</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">Action</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">skip</span> <span class="n">Headset</span> <span class="n">Pluged</span><span class="o">-</span><span class="n">out</span> <span class="n">broadcast</span><span class="o">.</span>
<span class="n">V</span> <span class="n">MediaRouter</span><span class="p">:</span> <span class="n">Audio</span> <span class="n">routes</span> <span class="n">updated</span><span class="p">:</span> <span class="n">AudioRoutesInfo</span><span class="p">{</span> <span class="nb">type</span><span class="o">=</span><span class="n">SPEAKER</span><span class="p">,</span> <span class="n">bluetoothName</span><span class="o">=</span><span class="n">zengjf</span> <span class="p">},</span> <span class="n">a2dp</span><span class="o">=</span><span class="n">true</span>
<span class="n">V</span> <span class="n">MediaRouter</span><span class="p">:</span> <span class="n">Selecting</span> <span class="n">route</span><span class="p">:</span> <span class="n">RouteInfo</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">zengjf</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">Bluetooth</span> <span class="n">audio</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">RouteCategory</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">System</span> <span class="n">types</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIO</span> <span class="n">ROUTE_TYPE_LIVE_VIDEO</span>  <span class="n">groupable</span><span class="o">=</span><span class="n">false</span> <span class="p">},</span> <span class="n">supportedTypes</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIO</span> <span class="p">,</span> <span class="n">presentationDisplay</span><span class="o">=</span><span class="n">null</span> <span class="p">}</span>
<span class="n">D</span> <span class="n">MediaRouter</span><span class="p">:</span> <span class="n">dispatchRouteUnselected</span> <span class="n">info</span><span class="p">:</span> <span class="n">RouteInfo</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">Phone</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">RouteCategory</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">System</span> <span class="n">types</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIO</span> <span class="n">ROUTE_TYPE_LIVE_VIDEO</span>  <span class="n">groupable</span><span class="o">=</span><span class="n">false</span> <span class="p">},</span> <span class="n">supportedTypes</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIO</span> <span class="n">ROUTE_TYPE_LIVE_VIDEO</span> <span class="p">,</span> <span class="n">presentationDisplay</span><span class="o">=</span><span class="n">null</span> <span class="p">}</span> <span class="nb">type</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">D</span> <span class="n">MediaRouter</span><span class="p">:</span> <span class="n">dispatchRouteSelected</span> <span class="n">info</span><span class="p">:</span> <span class="n">RouteInfo</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">zengjf</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">Bluetooth</span> <span class="n">audio</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">RouteCategory</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">System</span> <span class="n">types</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIOROUTE_TYPE_LIVE_VIDEO</span>  <span class="n">groupable</span><span class="o">=</span><span class="n">false</span> <span class="p">},</span> <span class="n">supportedTypes</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIO</span> <span class="p">,</span> <span class="n">presentationDisplay</span><span class="o">=</span><span class="n">null</span> <span class="p">}</span> <span class="nb">type</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">D</span> <span class="n">MediaRouter</span><span class="p">:</span> <span class="n">Dispatching</span> <span class="n">route</span> <span class="n">change</span><span class="p">:</span> <span class="n">RouteInfo</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">Phone</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">RouteCategory</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">System</span> <span class="n">types</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIO</span> <span class="n">ROUTE_TYPE_LIVE_VIDEO</span>  <span class="n">groupable</span><span class="o">=</span><span class="n">false</span> <span class="p">},</span> <span class="n">supportedTypes</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIO</span> <span class="n">ROUTE_TYPE_LIVE_VIDEO</span> <span class="p">,</span> <span class="n">presentationDisplay</span><span class="o">=</span><span class="n">null</span> <span class="p">}</span>
<span class="n">V</span> <span class="n">MediaRouter</span><span class="p">:</span> <span class="n">Audio</span> <span class="n">routes</span> <span class="n">updated</span><span class="p">:</span> <span class="n">AudioRoutesInfo</span><span class="p">{</span> <span class="nb">type</span><span class="o">=</span><span class="n">SPEAKER</span><span class="p">,</span> <span class="n">bluetoothName</span><span class="o">=</span><span class="n">zengjf</span> <span class="p">},</span> <span class="n">a2dp</span><span class="o">=</span><span class="n">true</span>
<span class="n">V</span> <span class="n">MediaRouter</span><span class="p">:</span> <span class="n">Selecting</span> <span class="n">route</span><span class="p">:</span> <span class="n">RouteInfo</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">zengjf</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">Bluetooth</span> <span class="n">audio</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">RouteCategory</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">System</span> <span class="n">types</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIO</span> <span class="n">ROUTE_TYPE_LIVE_VIDEO</span>  <span class="n">groupable</span><span class="o">=</span><span class="n">false</span> <span class="p">},</span> <span class="n">supportedTypes</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIO</span> <span class="p">,</span> <span class="n">presentationDisplay</span><span class="o">=</span><span class="n">null</span> <span class="p">}</span>
<span class="n">D</span> <span class="n">MediaRouter</span><span class="p">:</span> <span class="n">dispatchRouteUnselected</span> <span class="n">info</span><span class="p">:</span> <span class="n">RouteInfo</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">Phone</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">RouteCategory</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">System</span> <span class="n">types</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIO</span> <span class="n">ROUTE_TYPE_LIVE_VIDEO</span>  <span class="n">groupable</span><span class="o">=</span><span class="n">false</span> <span class="p">},</span> <span class="n">supportedTypes</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIO</span> <span class="n">ROUTE_TYPE_LIVE_VIDEO</span> <span class="p">,</span> <span class="n">presentationDisplay</span><span class="o">=</span><span class="n">null</span> <span class="p">}</span> <span class="nb">type</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">D</span> <span class="n">MediaRouter</span><span class="p">:</span> <span class="n">dispatchRouteSelected</span> <span class="n">info</span><span class="p">:</span> <span class="n">RouteInfo</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">zengjf</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">Bluetooth</span> <span class="n">audio</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">RouteCategory</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">System</span> <span class="n">types</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIOROUTE_TYPE_LIVE_VIDEO</span>  <span class="n">groupable</span><span class="o">=</span><span class="n">false</span> <span class="p">},</span> <span class="n">supportedTypes</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIO</span> <span class="p">,</span> <span class="n">presentationDisplay</span><span class="o">=</span><span class="n">null</span> <span class="p">}</span> <span class="nb">type</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">D</span> <span class="n">MediaRouter</span><span class="p">:</span> <span class="n">Dispatching</span> <span class="n">route</span> <span class="n">change</span><span class="p">:</span> <span class="n">RouteInfo</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">Phone</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">RouteCategory</span><span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="n">System</span> <span class="n">types</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIO</span> <span class="n">ROUTE_TYPE_LIVE_VIDEO</span>  <span class="n">groupable</span><span class="o">=</span><span class="n">false</span> <span class="p">},</span> <span class="n">supportedTypes</span><span class="o">=</span><span class="n">ROUTE_TYPE_LIVE_AUDIO</span> <span class="n">ROUTE_TYPE_LIVE_VIDEO</span> <span class="p">,</span> <span class="n">presentationDisplay</span><span class="o">=</span><span class="n">null</span> <span class="p">}</span>
<span class="n">D</span> <span class="n">MediaRouter</span><span class="p">:</span> <span class="n">dispatchRouteChanged</span> <span class="n">oldVisibility</span><span class="p">:</span> <span class="n">falsenewVisibility</span><span class="p">:</span> <span class="n">false</span>
<span class="n">E</span> <span class="n">AVSync</span>  <span class="p">:</span> <span class="nb">open</span> <span class="n">dev</span> <span class="n">failed</span><span class="p">:</span> <span class="n">retry</span><span class="o">=</span><span class="mi">23178</span><span class="p">,</span> <span class="n">g_fd_avsync</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">errno</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
<span class="n">I</span> <span class="n">Telecom</span><span class="o">-</span><span class="n">WiredHeadsetManager</span><span class="p">:</span> <span class="n">ACTION_HEADSET_PLUG</span> <span class="n">event</span><span class="p">,</span> <span class="n">plugged</span> <span class="ow">in</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span> <span class="p">:</span> <span class="n">WHC</span><span class="o">.</span><span class="n">oADR</span><span class="nd">@wgk</span>
</pre></div>
</div>
<ul>
<li><p>I AS.AudioDeviceInventory: deviceKey:0x80000010:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="n">frameworks</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">AudioSystem</span><span class="o">.</span><span class="n">java</span>
  <span class="o">*</span> <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_BIT_IN</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
  <span class="o">*</span> <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_IN_WIRED_HEADSET</span> <span class="o">=</span> <span class="n">DEVICE_BIT_IN</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">;</span>
</pre></div>
</div>
<ul>
<li><p>不知道为什么又识别到这个headset，不过最终还是没有使用</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">sendDeviceConnectionIntent</span><span class="p">(</span><span class="n">dev</span><span class="p">:</span><span class="mh">0x80000010</span> <span class="n">state</span><span class="p">:</span><span class="mh">0x0</span> <span class="n">address</span><span class="p">:</span> <span class="n">name</span><span class="p">:);</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">sendDeviceConnectionIntent</span><span class="p">(</span><span class="n">dev</span><span class="p">:</span><span class="mh">0x80000010</span> <span class="n">state</span><span class="p">:</span><span class="mh">0x0</span><span class="p">[</span><span class="n">headset</span><span class="p">]</span> <span class="n">address</span><span class="p">:</span> <span class="n">name</span><span class="p">:);</span>
<span class="n">E</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">Action</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">skip</span> <span class="n">Headset</span> <span class="n">Pluged</span><span class="o">-</span><span class="n">out</span> <span class="n">broadcast</span><span class="o">.</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</li>
<li><p>getevent</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">device</span> <span class="mi">1</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event5</span>
  <span class="n">name</span><span class="p">:</span>     <span class="s2">&quot;betterlife_inputdev&quot;</span>
<span class="n">add</span> <span class="n">device</span> <span class="mi">2</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event4</span>
  <span class="n">name</span><span class="p">:</span>     <span class="s2">&quot;mtk-tpd&quot;</span>
<span class="n">add</span> <span class="n">device</span> <span class="mi">3</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event2</span>
  <span class="n">name</span><span class="p">:</span>     <span class="s2">&quot;hwmdata&quot;</span>
<span class="n">add</span> <span class="n">device</span> <span class="mi">4</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event0</span>
  <span class="n">name</span><span class="p">:</span>     <span class="s2">&quot;ACCDET&quot;</span>
<span class="n">add</span> <span class="n">device</span> <span class="mi">5</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event3</span>
  <span class="n">name</span><span class="p">:</span>     <span class="s2">&quot;bsp_gpios&quot;</span>
<span class="n">add</span> <span class="n">device</span> <span class="mi">6</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event1</span>
  <span class="n">name</span><span class="p">:</span>     <span class="s2">&quot;mtk-kpd&quot;</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event0</span><span class="p">:</span> <span class="mi">0005</span> <span class="mi">0004</span> <span class="mi">00000001</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event0</span><span class="p">:</span> <span class="mi">0000</span> <span class="mi">0000</span> <span class="mi">00000000</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event0</span><span class="p">:</span> <span class="mi">0005</span> <span class="mi">0004</span> <span class="mi">00000000</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event0</span><span class="p">:</span> <span class="mi">0000</span> <span class="mi">0000</span> <span class="mi">00000000</span>
</pre></div>
</div>
<ul class="simple">
<li><p>/dev/input/event0: 0005 0004 00000001</p>
<ul>
<li><p>插入事件</p></li>
</ul>
</li>
<li><p>/dev/input/event0: 0005 0004 00000000</p>
<ul>
<li><p>拔出事件</p></li>
</ul>
</li>
</ul>
</li>
<li><p>getevent -l</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">device</span> <span class="mi">1</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event5</span>
  <span class="n">name</span><span class="p">:</span>     <span class="s2">&quot;betterlife_inputdev&quot;</span>
<span class="n">add</span> <span class="n">device</span> <span class="mi">2</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event4</span>
  <span class="n">name</span><span class="p">:</span>     <span class="s2">&quot;mtk-tpd&quot;</span>
<span class="n">add</span> <span class="n">device</span> <span class="mi">3</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event2</span>
  <span class="n">name</span><span class="p">:</span>     <span class="s2">&quot;hwmdata&quot;</span>
<span class="n">add</span> <span class="n">device</span> <span class="mi">4</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event0</span>
  <span class="n">name</span><span class="p">:</span>     <span class="s2">&quot;ACCDET&quot;</span>
<span class="n">add</span> <span class="n">device</span> <span class="mi">5</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event3</span>
  <span class="n">name</span><span class="p">:</span>     <span class="s2">&quot;bsp_gpios&quot;</span>
<span class="n">add</span> <span class="n">device</span> <span class="mi">6</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event1</span>
  <span class="n">name</span><span class="p">:</span>     <span class="s2">&quot;mtk-kpd&quot;</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event0</span><span class="p">:</span> <span class="n">EV_SW</span>        <span class="n">SW_MICROPHONE_INSERT</span> <span class="mi">00000001</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event0</span><span class="p">:</span> <span class="n">EV_SYN</span>       <span class="n">SYN_REPORT</span>           <span class="mi">00000000</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event0</span><span class="p">:</span> <span class="n">EV_SW</span>        <span class="n">SW_MICROPHONE_INSERT</span> <span class="mi">00000000</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">event0</span><span class="p">:</span> <span class="n">EV_SYN</span>       <span class="n">SYN_REPORT</span>           <span class="mi">00000000</span>
</pre></div>
</div>
</li>
<li><p>MT6357</p>
<ul class="simple">
<li><p>ACCDET</p>
<ul>
<li><p>Accessory Detection</p></li>
</ul>
</li>
</ul>
</li>
<li><p>kernel</p>
<ul>
<li><p>耳机插入</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[12722.720755] (4)[99:pmic_thread][PMIC] [PMIC_INT] Reg[0x20ae]=0x40
[12722.720923] (4)[99:pmic_thread]accdet_eint_handler() enter
[12722.720960] (4)[99:pmic_thread]accdet_irq_handle() IRQ_STS = 0x4, pmic eint-0 triggered.
[12722.721002] (4)[99:pmic_thread]clear_accdet_eint() eint-0 IRQ-STS:[0x2320]=0x4404
[12722.721089] (4)[99:pmic_thread]clear_accdet_eint_check() eint-0 IRQ-STS:[0x2320]=0x4000 TOP_INT_STS:[0x20ae]:0x0
[12722.721110] (4)[99:pmic_thread]pmic_eint_queue_work() Enter. eint-0
[12722.721208] (4)[99:pmic_thread]accdet_eint_handler() exit
[12722.721424] (7)[27616:kworker/u16:4]accdet eint_work_callback(),DCC EINT func
[12722.721454] (7)[27616:kworker/u16:4]accdet cur: plug-in, cur_eint_state = 1
[12722.724549] (7)[27616:kworker/u16:4]accdet_init() done.
[12722.725062] (7)[27616:kworker/u16:4]enable_accdet done IRQ-STS[0x2320]=0x4000,STATE_SWCTRL[0x230c]=0xf0f
[12722.803197] (4)[99:pmic_thread][PMIC] [PMIC_INT] Reg[0x20ae]=0x20
[12722.803524] (4)[99:pmic_thread]accdet_int_handler()
[12722.803556] (4)[99:pmic_thread]accdet_irq_handle() IRQ_STS = 0x4001, IRQ triggered
[12722.803595] (4)[99:pmic_thread]clear_accdet_int() IRQ_STS = 0x4101
[12722.803705] (6)[27616:kworker/u16:4]accdet check_cable_type(), cur_status:Plug_out current AB = 1
[12722.803747] (6)[27616:kworker/u16:4]accdet cur cable type:[Headset_mic], status switch:[Plug_out]-&gt;[Headset_plug_in]
[12722.804054] (6)[27616:kworker/u16:4]send_accdet_status_event MICROPHONE(4-pole) PlugIn
[12722.804081] (6)[27616:kworker/u16:4]accdet_work_callback() report cable_type done
[12722.818566] (4)[10164:HwBinder:531_5]mt635x-auxadc mt-pmic:mt635x-auxadc: name:ACCDET, channel=5, adc_out=0xb86, adc_result=1296
[12722.818622] (4)[10164:HwBinder:531_5]hp_plugged_in_set(), mic_vinp_mv = 1296
[12722.818845] (4)[10164:HwBinder:531_5]AudDrv_Clk_On, Aud_AFE_Clk_cntr:0
[12722.818984] (4)[10164:HwBinder:531_5]AudDrv_AUDINTBUS_Sel(), parentidx = 1, CLK_CFG_4 = 0x83838101\x0d
[12722.819136] (4)[10164:HwBinder:531_5]TurnOnDacPower()
[12722.819167] (4)[10164:HwBinder:531_5]-PMIC DCXO XO_AUDIO_EN_M enable, DCXO_CW14 = 0xa2b5
[12722.819802] (4)[10164:HwBinder:531_5]setDlMtkifSrc(), enable = 1, freq = 48000
[12722.824097] (4)[10164:HwBinder:531_5]mt635x-auxadc mt-pmic:mt635x-auxadc: name:HPOFS_CAL, channel=9, adc_out=0x6fb0, adc_result=28592
[12722.826756] (4)[10164:HwBinder:531_5]mt635x-auxadc mt-pmic:mt635x-auxadc: name:HPOFS_CAL, channel=9, adc_out=0x6fad, adc_result=28589
[12722.829388] (4)[10164:HwBinder:531_5]mt635x-auxadc mt-pmic:mt635x-auxadc: name:HPOFS_CAL, channel=9, adc_out=0x6fb6, adc_result=28598
[12722.832047] (4)[10164:HwBinder:531_5]mt635x-auxadc mt-pmic:mt635x-auxadc: name:HPOFS_CAL, channel=9, adc_out=0x6f9d, adc_result=28573
[12722.886229] (4)[10164:HwBinder:531_5]detect_impedance(), phase 2 [dc,detect]Sum 8 times [228702,231701], hp_impedance 31, pick_impedance 61, AUXADC_CON10 0x65
[12722.904467] (7)[10164:HwBinder:531_5]TurnOffDacPower()
[12722.904506] (7)[10164:HwBinder:531_5]setDlMtkifSrc(), enable = 0, freq = 48000
[12722.904872] (7)[10164:HwBinder:531_5]-PMIC DCXO XO_AUDIO_EN_M disable, DCXO_CW14 = 0x82b5
[12722.905251] (7)[10164:HwBinder:531_5]!! AudDrv_Clk_Off, Aud_AFE_Clk_cntr:1
[12722.905307] (7)[10164:HwBinder:531_5]AudDrv_AUDINTBUS_Sel(), parentidx = 0, CLK_CFG_4 = 0x83838100\x0d
[12722.905364] (7)[10164:HwBinder:531_5]hp_impedance_get(), hp_impedance = 31, efuse = -1
[12723.171826] (4)[23152:kworker/u16:1][CH3_DBG] bat_cur = 47
</pre></div>
</div>
<ul class="simple">
<li><p>耳机插入经过两次中断处理</p></li>
</ul>
</li>
<li><p>耳机拔出</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mf">12724.910853</span><span class="p">]</span> <span class="p">(</span><span class="mi">4</span><span class="p">)[</span><span class="mi">99</span><span class="p">:</span><span class="n">pmic_thread</span><span class="p">][</span><span class="n">PMIC</span><span class="p">]</span> <span class="p">[</span><span class="n">PMIC_INT</span><span class="p">]</span> <span class="n">Reg</span><span class="p">[</span><span class="mh">0x20ae</span><span class="p">]</span><span class="o">=</span><span class="mh">0x40</span>
<span class="p">[</span><span class="mf">12724.910945</span><span class="p">]</span> <span class="p">(</span><span class="mi">4</span><span class="p">)[</span><span class="mi">99</span><span class="p">:</span><span class="n">pmic_thread</span><span class="p">]</span><span class="n">accdet_eint_handler</span><span class="p">()</span> <span class="n">enter</span>
<span class="p">[</span><span class="mf">12724.910993</span><span class="p">]</span> <span class="p">(</span><span class="mi">4</span><span class="p">)[</span><span class="mi">99</span><span class="p">:</span><span class="n">pmic_thread</span><span class="p">]</span><span class="n">accdet_irq_handle</span><span class="p">()</span> <span class="n">IRQ_STS</span> <span class="o">=</span> <span class="mh">0x4004</span><span class="p">,</span> <span class="n">pmic</span> <span class="n">eint</span><span class="o">-</span><span class="mi">0</span> <span class="n">triggered</span><span class="o">.</span>
<span class="p">[</span><span class="mf">12724.911049</span><span class="p">]</span> <span class="p">(</span><span class="mi">4</span><span class="p">)[</span><span class="mi">99</span><span class="p">:</span><span class="n">pmic_thread</span><span class="p">]</span><span class="n">clear_accdet_eint</span><span class="p">()</span> <span class="n">eint</span><span class="o">-</span><span class="mi">0</span> <span class="n">IRQ</span><span class="o">-</span><span class="n">STS</span><span class="p">:[</span><span class="mh">0x2320</span><span class="p">]</span><span class="o">=</span><span class="mh">0x404</span>
<span class="p">[</span><span class="mf">12724.911160</span><span class="p">]</span> <span class="p">(</span><span class="mi">4</span><span class="p">)[</span><span class="mi">99</span><span class="p">:</span><span class="n">pmic_thread</span><span class="p">]</span><span class="n">clear_accdet_eint_check</span><span class="p">()</span> <span class="n">eint</span><span class="o">-</span><span class="mi">0</span> <span class="n">IRQ</span><span class="o">-</span><span class="n">STS</span><span class="p">:[</span><span class="mh">0x2320</span><span class="p">]</span><span class="o">=</span><span class="mh">0x0</span> <span class="n">TOP_INT_STS</span><span class="p">:[</span><span class="mh">0x20ae</span><span class="p">]:</span><span class="mh">0x0</span>
<span class="p">[</span><span class="mf">12724.911190</span><span class="p">]</span> <span class="p">(</span><span class="mi">4</span><span class="p">)[</span><span class="mi">99</span><span class="p">:</span><span class="n">pmic_thread</span><span class="p">]</span><span class="n">pmic_eint_queue_work</span><span class="p">()</span> <span class="n">Enter</span><span class="o">.</span> <span class="n">eint</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span><span class="mf">12724.911568</span><span class="p">]</span> <span class="p">(</span><span class="mi">6</span><span class="p">)[</span><span class="mi">12336</span><span class="p">:</span><span class="n">kworker</span><span class="o">/</span><span class="n">u16</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="n">accdet</span> <span class="n">eint_work_callback</span><span class="p">(),</span><span class="n">DCC</span> <span class="n">EINT</span> <span class="n">func</span>
<span class="p">[</span><span class="mf">12724.911585</span><span class="p">]</span> <span class="p">(</span><span class="mi">4</span><span class="p">)[</span><span class="mi">99</span><span class="p">:</span><span class="n">pmic_thread</span><span class="p">]</span><span class="n">accdet_eint_handler</span><span class="p">()</span> <span class="n">exit</span>
<span class="p">[</span><span class="mf">12724.911642</span><span class="p">]</span> <span class="p">(</span><span class="mi">6</span><span class="p">)[</span><span class="mi">12336</span><span class="p">:</span><span class="n">kworker</span><span class="o">/</span><span class="n">u16</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="n">accdet</span> <span class="n">cur</span><span class="p">:</span><span class="n">plug</span><span class="o">-</span><span class="n">out</span><span class="p">,</span> <span class="n">cur_eint_state</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">[</span><span class="mf">12724.911723</span><span class="p">]</span> <span class="p">(</span><span class="mi">6</span><span class="p">)[</span><span class="mi">12336</span><span class="p">:</span><span class="n">kworker</span><span class="o">/</span><span class="n">u16</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="n">clear_accdet_int</span><span class="p">()</span> <span class="n">IRQ_STS</span> <span class="o">=</span> <span class="mh">0x100</span>
<span class="p">[</span><span class="mf">12724.911989</span><span class="p">]</span> <span class="p">(</span><span class="mi">6</span><span class="p">)[</span><span class="mi">12336</span><span class="p">:</span><span class="n">kworker</span><span class="o">/</span><span class="n">u16</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="n">disable_accdet</span> <span class="n">done</span> <span class="n">IRQ</span><span class="o">-</span><span class="n">STS</span><span class="p">[</span><span class="mh">0x2320</span><span class="p">]</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span><span class="n">STATE_SWCTRL</span><span class="p">[</span><span class="mh">0x230c</span><span class="p">]</span><span class="o">=</span><span class="mh">0x808</span>
<span class="p">[</span><span class="mf">12724.912028</span><span class="p">]</span> <span class="p">(</span><span class="mi">6</span><span class="p">)[</span><span class="mi">12336</span><span class="p">:</span><span class="n">kworker</span><span class="o">/</span><span class="n">u16</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="n">accdet</span> <span class="n">headset_plug_out</span>
<span class="p">[</span><span class="mf">12724.912589</span><span class="p">]</span> <span class="p">(</span><span class="mi">6</span><span class="p">)[</span><span class="mi">12336</span><span class="p">:</span><span class="n">kworker</span><span class="o">/</span><span class="n">u16</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="n">send_accdet_status_event</span> <span class="n">MICROPHONE</span><span class="p">(</span><span class="mi">4</span><span class="o">-</span><span class="n">pole</span><span class="p">)</span> <span class="n">PlugOut</span>
<span class="p">[</span><span class="mf">12724.912628</span><span class="p">]</span> <span class="p">(</span><span class="mi">6</span><span class="p">)[</span><span class="mi">12336</span><span class="p">:</span><span class="n">kworker</span><span class="o">/</span><span class="n">u16</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="n">accdet</span> <span class="n">headset_plug_out</span><span class="p">,</span> <span class="nb">set</span> <span class="n">cable_type</span> <span class="o">=</span> <span class="n">NO_DEVICE</span>
</pre></div>
</div>
<ul class="simple">
<li><p>耳机拔出经过一次中断处理</p></li>
</ul>
</li>
<li><p>driver</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="n">kernel</span><span class="o">-</span><span class="mf">4.9</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">misc</span><span class="o">/</span><span class="n">mediatek</span><span class="o">/</span><span class="n">accdet</span><span class="o">/</span><span class="n">mt6357</span><span class="o">/</span><span class="n">accdet</span><span class="o">.</span><span class="n">c</span>
  <span class="o">*</span> <span class="n">static</span> <span class="n">void</span> <span class="n">eint_work_callback</span><span class="p">(</span><span class="n">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
    <span class="o">*</span> <span class="n">headset_plug_out</span><span class="p">();</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Frameworks</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="n">frameworks</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">AudioSystem</span><span class="o">.</span><span class="n">java</span>
  <span class="o">/*</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_NONE</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
  <span class="o">//</span> <span class="n">reserved</span> <span class="n">bits</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_BIT_IN</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_BIT_DEFAULT</span> <span class="o">=</span> <span class="mh">0x40000000</span><span class="p">;</span>
  <span class="o">//</span> <span class="n">output</span> <span class="n">devices</span><span class="p">,</span> <span class="n">be</span> <span class="n">sure</span> <span class="n">to</span> <span class="n">update</span> <span class="n">AudioManager</span><span class="o">.</span><span class="n">java</span> <span class="n">also</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_EARPIECE</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_SPEAKER</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_WIRED_HEADSET</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_WIRED_HEADPHONE</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_BLUETOOTH_SCO</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_BLUETOOTH_SCO_HEADSET</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_BLUETOOTH_SCO_CARKIT</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_BLUETOOTH_A2DP</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_BLUETOOTH_A2DP_HEADPHONES</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_BLUETOOTH_A2DP_SPEAKER</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">;</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_AUX_DIGITAL</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_HDMI</span> <span class="o">=</span> <span class="n">DEVICE_OUT_AUX_DIGITAL</span><span class="p">;</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_ANLG_DOCK_HEADSET</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">;</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_DGTL_DOCK_HEADSET</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_USB_ACCESSORY</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_USB_DEVICE</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_REMOTE_SUBMIX</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
  <span class="nd">@UnsupportedAppUsage</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_TELEPHONY_TX</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_LINE</span> <span class="o">=</span> <span class="mh">0x20000</span><span class="p">;</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_HDMI_ARC</span> <span class="o">=</span> <span class="mh">0x40000</span><span class="p">;</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DEVICE_OUT_SPDIF</span> <span class="o">=</span> <span class="mh">0x80000</span><span class="p">;</span>
  <span class="o">*/</span>
<span class="o">*</span> <span class="n">frameworks</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">InputManagerService</span><span class="o">.</span><span class="n">java</span>
  <span class="o">*</span> <span class="n">private</span> <span class="n">void</span> <span class="n">notifySwitch</span><span class="p">(</span><span class="n">long</span> <span class="n">whenNanos</span><span class="p">,</span> <span class="nb">int</span> <span class="n">switchValues</span><span class="p">,</span> <span class="nb">int</span> <span class="n">switchMask</span><span class="p">)</span>
    <span class="o">*</span> <span class="n">mWiredAccessoryCallbacks</span><span class="o">.</span><span class="n">notifyWiredAccessoryChanged</span><span class="p">(</span><span class="n">whenNanos</span><span class="p">,</span> <span class="n">switchValues</span><span class="p">,</span> <span class="n">switchMask</span><span class="p">);</span>
      <span class="o">*</span> <span class="n">frameworks</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">WiredAccessoryManager</span><span class="o">.</span><span class="n">java</span>
        <span class="o">*</span> <span class="n">public</span> <span class="n">void</span> <span class="n">notifyWiredAccessoryChanged</span><span class="p">(</span><span class="n">long</span> <span class="n">whenNanos</span><span class="p">,</span> <span class="nb">int</span> <span class="n">switchValues</span><span class="p">,</span> <span class="nb">int</span> <span class="n">switchMask</span><span class="p">)</span>
          <span class="o">*</span> <span class="n">updateLocked</span><span class="p">(</span><span class="n">NAME_H2W</span><span class="p">,</span> <span class="p">(</span><span class="n">mHeadsetState</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT_HEADSET</span> <span class="o">|</span> <span class="n">BIT_HEADSET_NO_MIC</span> <span class="o">|</span> <span class="n">BIT_LINEOUT</span><span class="p">))</span> <span class="o">|</span> <span class="n">headset</span><span class="p">);</span>
            <span class="o">*</span> <span class="n">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mHandler</span><span class="o">.</span><span class="n">obtainMessage</span><span class="p">(</span><span class="n">MSG_NEW_DEVICE_STATE</span><span class="p">,</span> <span class="n">headsetState</span><span class="p">,</span> <span class="n">mHeadsetState</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
            <span class="o">*</span> <span class="n">mHandler</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
        <span class="o">*</span> <span class="n">private</span> <span class="n">final</span> <span class="n">Handler</span> <span class="n">mHandler</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Handler</span><span class="p">(</span><span class="n">Looper</span><span class="o">.</span><span class="n">myLooper</span><span class="p">(),</span> <span class="n">null</span><span class="p">,</span> <span class="n">true</span><span class="p">)</span>
          <span class="o">*</span> <span class="n">setDevicesState</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">arg1</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">arg2</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="n">msg</span><span class="o">.</span><span class="n">obj</span><span class="p">);</span>
            <span class="o">*</span> <span class="n">setDeviceStateLocked</span><span class="p">(</span><span class="n">curHeadset</span><span class="p">,</span> <span class="n">headsetState</span><span class="p">,</span> <span class="n">prevHeadsetState</span><span class="p">,</span> <span class="n">headsetName</span><span class="p">);</span>
              <span class="o">*</span> <span class="n">outDevice</span> <span class="o">=</span> <span class="n">AudioManager</span><span class="o">.</span><span class="n">DEVICE_OUT_WIRED_HEADSET</span><span class="p">;</span>
              <span class="o">*</span> <span class="n">inDevice</span> <span class="o">=</span> <span class="n">AudioManager</span><span class="o">.</span><span class="n">DEVICE_IN_WIRED_HEADSET</span><span class="p">;</span>
              <span class="o">*</span> <span class="n">mAudioManager</span><span class="o">.</span><span class="n">setWiredDeviceConnectionState</span><span class="p">(</span><span class="n">outDevice</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">headsetName</span><span class="p">);</span>
                <span class="o">*</span> <span class="n">frameworks</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">AudioManager</span><span class="o">.</span><span class="n">java</span>
                  <span class="o">*</span> <span class="n">public</span> <span class="n">void</span> <span class="n">setWiredDeviceConnectionState</span><span class="p">(</span><span class="nb">int</span> <span class="nb">type</span><span class="p">,</span> <span class="nb">int</span> <span class="n">state</span><span class="p">,</span> <span class="n">String</span> <span class="n">address</span><span class="p">,</span> <span class="n">String</span> <span class="n">name</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">final</span> <span class="n">IAudioService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">getService</span><span class="p">();</span>
                    <span class="o">*</span> <span class="n">service</span><span class="o">.</span><span class="n">setWiredDeviceConnectionState</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mApplicationContext</span><span class="o">.</span><span class="n">getOpPackageName</span><span class="p">());</span>
                      <span class="o">*</span> <span class="n">frameworks</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">audio</span><span class="o">/</span><span class="n">AudioService</span><span class="o">.</span><span class="n">java</span>
                        <span class="o">*</span> <span class="n">public</span> <span class="n">void</span> <span class="n">setWiredDeviceConnectionState</span><span class="p">(</span><span class="nb">int</span> <span class="nb">type</span><span class="p">,</span> <span class="nd">@ConnectionState</span> <span class="nb">int</span> <span class="n">state</span><span class="p">,</span> <span class="n">String</span> <span class="n">address</span><span class="p">,</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">String</span> <span class="n">caller</span><span class="p">)</span>
                          <span class="o">*</span> <span class="nb">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">checkSendBecomingNoisyIntentInt</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">AudioSystem</span><span class="o">.</span><span class="n">DEVICE_NONE</span><span class="p">);</span>
                            <span class="o">*</span> <span class="k">if</span> <span class="p">((</span><span class="n">device</span> <span class="o">&amp;</span> <span class="n">mBecomingNoisyIntentDevices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                              <span class="o">*</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                                <span class="o">*</span> <span class="n">private</span> <span class="nb">int</span> <span class="n">mBecomingNoisyIntentDevices</span>
                                  <span class="o">*</span> <span class="n">可以解决拔出暂停问题</span>
                          <span class="o">*</span> <span class="n">mDeviceBroker</span><span class="o">.</span><span class="n">setWiredDeviceConnectionState</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">caller</span><span class="p">);</span>
                            <span class="o">*</span> <span class="n">mDeviceBroker在AudioService</span><span class="p">()</span><span class="n">构造函数中处理</span>
                              <span class="o">*</span> <span class="n">public</span> <span class="n">AudioService</span><span class="p">(</span><span class="n">Context</span> <span class="n">context</span><span class="p">)</span>
                                <span class="o">*</span> <span class="n">mDeviceBroker</span> <span class="o">=</span> <span class="n">new</span> <span class="n">AudioDeviceBroker</span><span class="p">(</span><span class="n">mContext</span><span class="p">,</span> <span class="n">this</span><span class="p">);</span>
                                  <span class="o">*</span> <span class="n">frameworks</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">audio</span><span class="o">/</span><span class="n">AudioDeviceBroker</span><span class="o">.</span><span class="n">java</span>
                                    <span class="o">*</span> <span class="n">void</span> <span class="n">setWiredDeviceConnectionState</span><span class="p">(</span><span class="nb">int</span> <span class="nb">type</span><span class="p">,</span> <span class="nd">@AudioService</span><span class="o">.</span><span class="n">ConnectionState</span> <span class="nb">int</span> <span class="n">state</span><span class="p">,</span> <span class="n">String</span> <span class="n">address</span><span class="p">,</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">String</span> <span class="n">caller</span><span class="p">)</span>
                                      <span class="o">*</span> <span class="n">mDeviceInventory</span><span class="o">.</span><span class="n">setWiredDeviceConnectionState</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">caller</span><span class="p">);</span>
                                        <span class="o">*</span> <span class="n">mDeviceBroker</span><span class="o">.</span><span class="n">postSetWiredDeviceConnectionState</span><span class="p">(</span><span class="n">new</span> <span class="n">WiredDeviceConnectionState</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">caller</span><span class="p">),</span> <span class="n">delay</span><span class="p">);</span>
                                          <span class="o">*</span> <span class="n">frameworks</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">audio</span><span class="o">/</span><span class="n">AudioDeviceInventory</span><span class="o">.</span><span class="n">java</span>
                                            <span class="o">*</span> <span class="n">WiredDeviceConnectionState</span><span class="p">(</span><span class="nb">int</span> <span class="nb">type</span><span class="p">,</span> <span class="nd">@AudioService</span><span class="o">.</span><span class="n">ConnectionState</span> <span class="nb">int</span> <span class="n">state</span><span class="p">,</span> <span class="n">String</span> <span class="n">address</span><span class="p">,</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">String</span> <span class="n">caller</span><span class="p">)</span>
                                          <span class="o">*</span> <span class="n">frameworks</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">audio</span><span class="o">/</span><span class="n">AudioDeviceBroker</span><span class="o">.</span><span class="n">java</span>
                                            <span class="o">*</span> <span class="n">void</span> <span class="n">postSetWiredDeviceConnectionState</span><span class="p">(</span><span class="n">AudioDeviceInventory</span><span class="o">.</span><span class="n">WiredDeviceConnectionState</span> <span class="n">connectionState</span><span class="p">,</span> <span class="nb">int</span> <span class="n">delay</span><span class="p">)</span>
                                              <span class="o">*</span> <span class="n">sendLMsg</span><span class="p">(</span><span class="n">MSG_L_SET_WIRED_DEVICE_CONNECTION_STATE</span><span class="p">,</span> <span class="n">SENDMSG_QUEUE</span><span class="p">,</span> <span class="n">connectionState</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
                                                <span class="o">*</span> <span class="n">sendIILMsg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">existingMsgPolicy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
                                                  <span class="o">*</span> <span class="n">private</span> <span class="n">void</span> <span class="n">sendIILMsg</span><span class="p">(</span><span class="nb">int</span> <span class="n">msg</span><span class="p">,</span> <span class="nb">int</span> <span class="n">existingMsgPolicy</span><span class="p">,</span> <span class="nb">int</span> <span class="n">arg1</span><span class="p">,</span> <span class="nb">int</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">Object</span> <span class="n">obj</span><span class="p">,</span> <span class="nb">int</span> <span class="n">delay</span><span class="p">)</span>
                                                    <span class="o">*</span> <span class="n">mBrokerHandler</span><span class="o">.</span><span class="n">sendMessageAtTime</span><span class="p">(</span><span class="n">mBrokerHandler</span><span class="o">.</span><span class="n">obtainMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">obj</span><span class="p">),</span> <span class="n">time</span><span class="p">);</span>
                                            <span class="o">*</span> <span class="n">private</span> <span class="k">class</span> <span class="nc">BrokerThread</span> <span class="n">extends</span> <span class="n">Thread</span>
                                              <span class="o">*</span> <span class="n">mBrokerHandler</span> <span class="o">=</span> <span class="n">new</span> <span class="n">BrokerHandler</span><span class="p">();</span>
                                            <span class="o">*</span> <span class="n">private</span> <span class="k">class</span> <span class="nc">BrokerHandler</span> <span class="n">extends</span> <span class="n">Handler</span>
                                              <span class="o">*</span> <span class="n">public</span> <span class="n">void</span> <span class="n">handleMessage</span><span class="p">(</span><span class="n">Message</span> <span class="n">msg</span><span class="p">)</span>
                                                <span class="o">*</span> <span class="n">case</span> <span class="n">MSG_L_SET_WIRED_DEVICE_CONNECTION_STATE</span><span class="p">:</span>
                                                  <span class="o">*</span> <span class="n">mDeviceInventory</span><span class="o">.</span><span class="n">onSetWiredDeviceConnectionState</span><span class="p">((</span><span class="n">AudioDeviceInventory</span><span class="o">.</span><span class="n">WiredDeviceConnectionState</span><span class="p">)</span> <span class="n">msg</span><span class="o">.</span><span class="n">obj</span><span class="p">);</span>
                                                    <span class="o">*</span> <span class="n">frameworks</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">audio</span><span class="o">/</span><span class="n">AudioDeviceInventory</span><span class="o">.</span><span class="n">java</span>
                                                      <span class="o">*</span> <span class="n">void</span> <span class="n">onSetWiredDeviceConnectionState</span><span class="p">(</span><span class="n">AudioDeviceInventory</span><span class="o">.</span><span class="n">WiredDeviceConnectionState</span> <span class="n">wdcs</span><span class="p">)</span>
                                                        <span class="o">*</span> <span class="n">handleDeviceConnection</span><span class="p">(</span><span class="n">wdcs</span><span class="o">.</span><span class="n">mState</span> <span class="o">==</span> <span class="n">AudioService</span><span class="o">.</span><span class="n">CONNECTION_STATE_CONNECTED</span><span class="p">,</span> <span class="n">wdcs</span><span class="o">.</span><span class="n">mType</span><span class="p">,</span> <span class="n">wdcs</span><span class="o">.</span><span class="n">mAddress</span><span class="p">,</span> <span class="n">wdcs</span><span class="o">.</span><span class="n">mName</span><span class="p">)</span>
                                                          <span class="o">*</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">AudioSystem</span><span class="o">.</span><span class="n">setDeviceConnectionState</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">AudioSystem</span><span class="o">.</span><span class="n">DEVICE_STATE_AVAILABLE</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">deviceName</span><span class="p">,</span> <span class="n">AudioSystem</span><span class="o">.</span><span class="n">AUDIO_FORMAT_DEFAULT</span><span class="p">);</span>
                                                          <span class="o">*</span> <span class="n">mDeviceBroker</span><span class="o">.</span><span class="n">postAccessoryPlugMediaUnmute</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
                                                            <span class="o">*</span> <span class="n">frameworks</span><span class="o">/</span><span class="n">av</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">audiopolicy</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">AudioPolicyInterfaceImpl</span><span class="o">.</span><span class="n">cpp</span>
                                                              <span class="o">*</span> <span class="n">status_t</span> <span class="n">AudioPolicyService</span><span class="p">::</span><span class="n">setDeviceConnectionState</span><span class="p">(</span><span class="n">audio_devices_t</span> <span class="n">device</span><span class="p">,</span> <span class="n">audio_policy_dev_state_t</span> <span class="n">state</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">device_address</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">device_name</span><span class="p">,</span> <span class="n">audio_format_t</span> <span class="n">encodedFormat</span><span class="p">)</span>
                                                                <span class="o">*</span> <span class="n">frameworks</span><span class="o">/</span><span class="n">av</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">audiopolicy</span><span class="o">/</span><span class="n">managerdefault</span><span class="o">/</span><span class="n">AudioPolicyManager</span><span class="o">.</span><span class="n">cpp</span>
                                                                  <span class="o">*</span> <span class="n">status</span> <span class="o">=</span> <span class="n">setDeviceConnectionStateInt</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">device_address</span><span class="p">,</span> <span class="n">device_name</span><span class="p">,</span> <span class="n">encodedFormat</span><span class="p">);</span>
              <span class="o">*</span> <span class="n">mAudioManager</span><span class="o">.</span><span class="n">setWiredDeviceConnectionState</span><span class="p">(</span><span class="n">inDevice</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">headsetName</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ul>
<p><img alt="0023_Android_Headset_Event.png" src="../../../_images/0023_Android_Headset_Event.png" /></p>
</section>
<section id="id3">
<h1>插拔耳机自动播放音乐<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h1>
<ul>
<li><p>应用收到ACTION_AUDIO_BECOMING_NOISY这个通知后会做一个暂停的处理；</p></li>
<li><p>frameworks/base/services/core/java/com/android/server/audio/AudioDeviceInventory.java</p>
<div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="n">rivate</span> <span class="kt">int</span> <span class="n">mBecomingNoisyIntentDevices</span> <span class="o">=</span>
       <span class="n">AudioSystem</span><span class="p">.</span><span class="na">DEVICE_OUT_WIRED_HEADSET</span> <span class="o">|</span> <span class="n">AudioSystem</span><span class="p">.</span><span class="na">DEVICE_OUT_WIRED_HEADPHONE</span>
               <span class="o">|</span> <span class="n">AudioSystem</span><span class="p">.</span><span class="na">DEVICE_OUT_ALL_A2DP</span> <span class="o">|</span> <span class="n">AudioSystem</span><span class="p">.</span><span class="na">DEVICE_OUT_HDMI</span>
               <span class="o">|</span> <span class="n">AudioSystem</span><span class="p">.</span><span class="na">DEVICE_OUT_ANLG_DOCK_HEADSET</span>
               <span class="o">|</span> <span class="n">AudioSystem</span><span class="p">.</span><span class="na">DEVICE_OUT_DGTL_DOCK_HEADSET</span>
               <span class="o">|</span> <span class="n">AudioSystem</span><span class="p">.</span><span class="na">DEVICE_OUT_ALL_USB</span> <span class="o">|</span> <span class="n">AudioSystem</span><span class="p">.</span><span class="na">DEVICE_OUT_LINE</span>
               <span class="o">|</span> <span class="n">AudioSystem</span><span class="p">.</span><span class="na">DEVICE_OUT_HEARING_AID</span><span class="p">;</span>

<span class="o">/</span> <span class="n">must</span> <span class="n">be</span> <span class="n">called</span> <span class="n">before</span> <span class="n">removing</span> <span class="n">the</span> <span class="n">device</span> <span class="n">from</span> <span class="n">mConnectedDevices</span>
<span class="o">/</span> <span class="n">musicDevice</span> <span class="n">argument</span> <span class="n">is</span> <span class="n">used</span> <span class="n">when</span> <span class="n">not</span> <span class="n">AudioSystem</span><span class="p">.</span><span class="na">DEVICE_NONE</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">querying</span>
<span class="o">/</span> <span class="n">from</span> <span class="n">AudioSystem</span>
<span class="nf">GuardedBy</span><span class="p">(</span><span class="s">&quot;mConnectedDevices&quot;</span><span class="p">)</span>
<span class="n">rivate</span> <span class="kt">int</span> <span class="nf">checkSendBecomingNoisyIntentInt</span><span class="p">(</span><span class="kt">int</span> <span class="n">device</span><span class="p">,</span>
       <span class="nd">@AudioService.ConnectionState</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">musicDevice</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">AudioService</span><span class="p">.</span><span class="na">CONNECTION_STATE_DISCONNECTED</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">((</span><span class="n">device</span> <span class="o">&amp;</span> <span class="n">mBecomingNoisyIntentDevices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">devices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mConnectedDevices</span><span class="p">.</span><span class="na">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
       <span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">mConnectedDevices</span><span class="p">.</span><span class="na">valueAt</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">mDeviceType</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(((</span><span class="n">dev</span> <span class="o">&amp;</span> <span class="n">AudioSystem</span><span class="p">.</span><span class="na">DEVICE_BIT_IN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
               <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">dev</span> <span class="o">&amp;</span> <span class="n">mBecomingNoisyIntentDevices</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
           <span class="n">devices</span> <span class="o">|=</span> <span class="n">dev</span><span class="p">;</span>
       <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">musicDevice</span> <span class="o">==</span> <span class="n">AudioSystem</span><span class="p">.</span><span class="na">DEVICE_NONE</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">musicDevice</span> <span class="o">=</span> <span class="n">mDeviceBroker</span><span class="p">.</span><span class="na">getDeviceForStream</span><span class="p">(</span><span class="n">AudioSystem</span><span class="p">.</span><span class="na">STREAM_MUSIC</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// always ignore condition on device being actually used for music when in communication</span>
   <span class="c1">// because music routing is altered in this case.</span>
   <span class="c1">// also checks whether media routing if affected by a dynamic policy or mirroring</span>
   <span class="k">if</span> <span class="p">(((</span><span class="n">device</span> <span class="o">==</span> <span class="n">musicDevice</span><span class="p">)</span> <span class="o">||</span> <span class="n">mDeviceBroker</span><span class="p">.</span><span class="na">isInCommunication</span><span class="p">())</span>
           <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">devices</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mDeviceBroker</span><span class="p">.</span><span class="na">hasMediaDynamicPolicy</span><span class="p">()</span>
                   <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">musicDevice</span> <span class="o">&amp;</span> <span class="n">AudioSystem</span><span class="p">.</span><span class="na">DEVICE_OUT_REMOTE_SUBMIX</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AudioSystem</span><span class="p">.</span><span class="na">isStreamActive</span><span class="p">(</span><span class="n">AudioSystem</span><span class="p">.</span><span class="na">STREAM_MUSIC</span><span class="p">,</span> <span class="mi">0</span> <span class="cm">/*not looking in past*/</span><span class="p">)</span>
               <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mDeviceBroker</span><span class="p">.</span><span class="na">hasAudioFocusUsers</span><span class="p">())</span> <span class="p">{</span>
           <span class="c1">// no media playback, not a &quot;becoming noisy&quot; situation, otherwise it could cause</span>
           <span class="c1">// the pausing of some apps that are playing remotely</span>
           <span class="n">AudioService</span><span class="p">.</span><span class="na">sDeviceLogger</span><span class="p">.</span><span class="na">log</span><span class="p">((</span><span class="k">new</span> <span class="n">AudioEventLogger</span><span class="p">.</span><span class="na">StringEvent</span><span class="p">(</span>
                   <span class="s">&quot;dropping ACTION_AUDIO_BECOMING_NOISY&quot;</span><span class="p">)).</span><span class="na">printLog</span><span class="p">(</span><span class="n">TAG</span><span class="p">));</span>
           <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="n">mDeviceBroker</span><span class="p">.</span><span class="na">postBroadcastBecomingNoisy</span><span class="p">();</span>
       <span class="n">delay</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">delay</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>修改过滤变量：mBecomingNoisyIntentDevices</p></li>
</ul>
</li>
</ul>
</section>
<section id="id4">
<h1>拔耳机切到蓝牙<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h1>
<ul>
<li><p><a class="reference external" href="https://blog.csdn.net/weixin_40537714/article/details/108069875">A2DP ：蓝牙耳机和有线耳机听同时连接，音频从有线耳机出来，拔掉有线耳机，音频不能自动切换到蓝牙耳机</a></p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">diff --git a/vendor/mediatek/proprietary/packages/apps/Bluetooth/src/com/android/bluetooth/btservice/ActiveDeviceManager.java b/vendor/mediatek/proprietary/packages/apps/Bluetooth/src/com/android/bluetooth/btservice/ActiveDeviceManager.java</span><span class="w"></span>
<span class="gh">index 69381c53db8..bdecd5f3418 100644</span><span class="w"></span>
<span class="gd">--- a/vendor/mediatek/proprietary/packages/apps/Bluetooth/src/com/android/bluetooth/btservice/ActiveDeviceManager.java</span><span class="w"></span>
<span class="gi">+++ b/vendor/mediatek/proprietary/packages/apps/Bluetooth/src/com/android/bluetooth/btservice/ActiveDeviceManager.java</span><span class="w"></span>
<span class="gu">@@ -355,7 +355,7 @@ class ActiveDeviceManager {</span><span class="w"></span>
<span class="w"> </span>                }<span class="w"></span>
<span class="w"> </span>            }<span class="w"></span>
<span class="w"> </span>            if (hasAddedWiredDevice) {<span class="w"></span>
<span class="gd">-                wiredAudioDeviceConnected();</span><span class="w"></span>
<span class="gi">+                // wiredAudioDeviceConnected();</span><span class="w"></span>
<span class="w"> </span>            }<span class="w"></span>
<span class="w"> </span>        }<span class="w"></span>
</pre></div>
</div>
</li>
<li><p>注册及处理流程</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="n">vendor</span><span class="o">/</span><span class="n">mediatek</span><span class="o">/</span><span class="n">proprietary</span><span class="o">/</span><span class="n">packages</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">Bluetooth</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">bluetooth</span><span class="o">/</span><span class="n">btservice</span><span class="o">/</span><span class="n">ActiveDeviceManager</span><span class="o">.</span><span class="n">java</span>
  <span class="o">*</span> <span class="n">ActiveDeviceManager</span><span class="p">(</span><span class="n">AdapterService</span> <span class="n">service</span><span class="p">,</span> <span class="n">ServiceFactory</span> <span class="n">factory</span><span class="p">)</span>
    <span class="o">*</span> <span class="n">mAudioManager</span> <span class="o">=</span> <span class="p">(</span><span class="n">AudioManager</span><span class="p">)</span> <span class="n">service</span><span class="o">.</span><span class="n">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="o">.</span><span class="n">AUDIO_SERVICE</span><span class="p">);</span>
    <span class="o">*</span> <span class="n">mAudioManagerAudioDeviceCallback</span> <span class="o">=</span> <span class="n">new</span> <span class="n">AudioManagerAudioDeviceCallback</span><span class="p">();</span>
      <span class="o">*</span> <span class="n">private</span> <span class="k">class</span> <span class="nc">AudioManagerAudioDeviceCallback</span> <span class="n">extends</span> <span class="n">AudioDeviceCallback</span>
        <span class="o">*</span> <span class="n">public</span> <span class="n">void</span> <span class="n">onAudioDevicesAdded</span><span class="p">(</span><span class="n">AudioDeviceInfo</span><span class="p">[]</span> <span class="n">addedDevices</span><span class="p">)</span>
          <span class="o">*</span> <span class="n">被AudioManager调用</span>
  <span class="o">*</span> <span class="n">void</span> <span class="n">start</span><span class="p">()</span>
    <span class="o">*</span> <span class="n">mAudioManager</span><span class="o">.</span><span class="n">registerAudioDeviceCallback</span><span class="p">(</span><span class="n">mAudioManagerAudioDeviceCallback</span><span class="p">,</span> <span class="n">mHandler</span><span class="p">);</span>
      <span class="o">*</span> <span class="n">将回调函数注册到AudioManager</span>
  <span class="o">*</span> <span class="n">void</span> <span class="n">wiredAudioDeviceConnected</span><span class="p">()</span>
    <span class="o">*</span> <span class="n">setA2dpActiveDevice</span><span class="p">(</span><span class="n">null</span><span class="p">);</span>
      <span class="o">*</span> <span class="n">final</span> <span class="n">A2dpService</span> <span class="n">a2dpService</span> <span class="o">=</span> <span class="n">mFactory</span><span class="o">.</span><span class="n">getA2dpService</span><span class="p">();</span>
      <span class="o">*</span> <span class="n">a2dpService</span><span class="o">.</span><span class="n">setActiveDevice</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">frameworks</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">bluetooth</span><span class="o">/</span><span class="n">BluetoothA2dp</span><span class="o">.</span><span class="n">java</span>
          <span class="o">*</span> <span class="n">final</span> <span class="n">IBluetoothA2dp</span> <span class="n">service</span> <span class="o">=</span> <span class="n">getService</span><span class="p">();</span>
          <span class="o">*</span> <span class="n">service</span><span class="o">.</span><span class="n">setActiveDevice</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
            <span class="o">*</span> <span class="n">frameworks</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">packages</span><span class="o">/</span><span class="n">SettingsLib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">settingslib</span><span class="o">/</span><span class="n">bluetooth</span><span class="o">/</span><span class="n">A2dpProfile</span><span class="o">.</span><span class="n">java</span>
              <span class="o">*</span> <span class="n">public</span> <span class="n">boolean</span> <span class="n">setActiveDevice</span><span class="p">(</span><span class="n">BluetoothDevice</span> <span class="n">device</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">vendor</span><span class="o">/</span><span class="n">mediatek</span><span class="o">/</span><span class="n">proprietary</span><span class="o">/</span><span class="n">packages</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">Bluetooth</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">bluetooth</span><span class="o">/</span><span class="n">a2dp</span><span class="o">/</span><span class="n">A2dpService</span><span class="o">.</span><span class="n">java</span>
                  <span class="o">*</span> <span class="n">public</span> <span class="n">boolean</span> <span class="n">setActiveDevice</span><span class="p">(</span><span class="n">BluetoothDevice</span> <span class="n">device</span><span class="p">)</span>
                    <span class="o">*</span> <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span>
                      <span class="o">*</span> <span class="n">removeActiveDevice</span><span class="p">(</span><span class="n">false</span><span class="p">);</span>
                        <span class="o">*</span> <span class="n">updateAndBroadcastActiveDevice</span><span class="p">(</span><span class="n">null</span><span class="p">);</span>
                        <span class="o">*</span> <span class="n">mAudioManager</span><span class="o">.</span><span class="n">setBluetoothA2dpDeviceConnectionStateSuppressNoisyIntent</span><span class="p">(</span><span class="n">previousActiveDevice</span><span class="p">,</span> <span class="n">BluetoothProfile</span><span class="o">.</span><span class="n">STATE_DISCONNECTED</span><span class="p">,</span> <span class="n">BluetoothProfile</span><span class="o">.</span><span class="n">A2DP</span><span class="p">,</span> <span class="n">suppressNoisyIntent</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>log</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">E</span> <span class="n">WiredAccessoryManager</span><span class="p">:</span> <span class="n">setDeviceState</span><span class="p">()</span> <span class="n">No</span> <span class="n">state</span> <span class="n">change</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">handleDeviceConnection</span><span class="p">(</span><span class="n">true</span> <span class="n">dev</span><span class="p">:</span><span class="mi">80000010</span> <span class="n">address</span><span class="p">:</span> <span class="n">name</span><span class="p">:)</span>
<span class="n">D</span> <span class="n">MediaRouter</span><span class="p">:</span> <span class="n">dispatchRouteChanged</span> <span class="n">oldVisibility</span><span class="p">:</span> <span class="n">falsenewVisibility</span><span class="p">:</span> <span class="n">false</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">handleDeviceConnection</span><span class="p">(</span><span class="n">true</span> <span class="n">dev</span><span class="p">:</span><span class="mi">80000010</span><span class="p">[</span><span class="n">headset</span><span class="p">]</span> <span class="n">address</span><span class="p">:</span> <span class="n">name</span><span class="p">:)</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">deviceKey</span><span class="p">:</span><span class="mh">0x80000010</span><span class="p">:</span>
<span class="n">I</span> <span class="n">AS</span><span class="o">.</span><span class="n">AudioDeviceInventory</span><span class="p">:</span> <span class="n">deviceInfo</span><span class="p">:</span><span class="n">null</span> <span class="ow">is</span><span class="p">(</span><span class="n">already</span><span class="p">)</span><span class="n">Connected</span><span class="p">:</span><span class="n">false</span>
<span class="n">V</span> <span class="n">AudioPolicyIntefaceImpl</span><span class="p">:</span> <span class="n">setDeviceConnectionState</span><span class="p">()</span>
<span class="n">D</span> <span class="n">APM_AudioPolicyManager</span><span class="p">:</span> <span class="n">setDeviceConnectionStateInt</span><span class="p">()</span> <span class="n">device</span><span class="p">:</span> <span class="mh">0x80000010</span><span class="p">,</span> <span class="n">state</span> <span class="mi">1</span><span class="p">,</span> <span class="n">address</span>  <span class="n">name</span>  <span class="nb">format</span> <span class="mh">0x0</span>
<span class="n">V</span> <span class="n">AudioPolicyService</span><span class="p">:</span> <span class="n">AudioCommandThread</span><span class="p">()</span> <span class="n">adding</span> <span class="nb">set</span> <span class="n">parameter</span> <span class="n">string</span> <span class="n">connect</span><span class="o">=-</span><span class="mi">2147483632</span><span class="p">,</span> <span class="n">io</span> <span class="mi">0</span> <span class="p">,</span><span class="n">delay</span> <span class="mi">0</span>
<span class="n">V</span> <span class="n">AudioPolicyService</span><span class="p">:</span> <span class="n">AudioCommandThread</span><span class="p">()</span> <span class="n">processing</span> <span class="nb">set</span> <span class="n">parameters</span> <span class="n">string</span> <span class="n">connect</span><span class="o">=-</span><span class="mi">2147483632</span><span class="p">,</span> <span class="n">io</span> <span class="mi">0</span>
<span class="n">D</span> <span class="n">AudioSystem</span><span class="p">:</span> <span class="o">+</span><span class="n">setParameters</span><span class="p">():</span> <span class="n">connect</span><span class="o">=-</span><span class="mi">2147483632</span>
<span class="n">D</span> <span class="n">BluetoothActiveDeviceManager</span><span class="p">:</span> <span class="n">onAudioDevicesAdded</span>
<span class="n">D</span> <span class="n">BluetoothActiveDeviceManager</span><span class="p">:</span> <span class="n">Audio</span> <span class="n">device</span> <span class="n">added</span><span class="p">:</span> <span class="n">C50</span> <span class="nb">type</span><span class="p">:</span> <span class="mi">3</span>
<span class="n">D</span> <span class="n">AudioALSAHardware</span><span class="p">:</span> <span class="o">+</span><span class="n">setParameters</span><span class="p">():</span> <span class="n">connect</span><span class="o">=-</span><span class="mi">2147483632</span>
<span class="n">D</span> <span class="n">AudioALSAHardware</span><span class="p">:</span> <span class="o">-</span><span class="n">setParameters</span><span class="p">():</span> <span class="n">connect</span><span class="o">=-</span><span class="mi">2147483632</span>
<span class="n">D</span> <span class="n">BluetoothActiveDeviceManager</span><span class="p">:</span> <span class="n">wiredAudioDeviceConnected</span>
<span class="n">D</span> <span class="n">BluetoothActiveDeviceManager</span><span class="p">:</span> <span class="n">setA2dpActiveDevice</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>
<span class="n">D</span> <span class="n">AudioALSAStreamManager</span><span class="p">:</span> <span class="n">openInputStream</span><span class="p">(),</span> <span class="n">devices</span> <span class="o">=</span> <span class="mh">0x80000010</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">,</span> <span class="n">sampleRate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">70</span><span class="p">,</span> <span class="n">acoustics</span> <span class="o">=</span> <span class="mh">0x0</span>
<span class="n">E</span> <span class="n">AVSync</span>  <span class="p">:</span> <span class="nb">open</span> <span class="n">dev</span> <span class="n">failed</span><span class="p">:</span> <span class="n">retry</span><span class="o">=</span><span class="mi">21813</span><span class="p">,</span> <span class="n">g_fd_avsync</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">errno</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
<span class="n">D</span> <span class="n">A2dpService</span><span class="p">:</span> <span class="n">setActiveDevice</span><span class="p">(</span><span class="n">null</span><span class="p">):</span> <span class="n">previous</span> <span class="ow">is</span> <span class="n">null</span>
<span class="n">D</span> <span class="n">AudioALSAStreamIn</span><span class="p">:</span> <span class="n">AudioALSAStreamIn</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, zengjf.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JjOE14XScyd75b2C",ck: "JjOE14XScyd75b2C"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JjOE14XScyd75b2C/quote.js?theme=0&f=12&display=1,0,0,0,0,0,1,1"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>