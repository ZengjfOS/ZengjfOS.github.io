<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>zengjf</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/login.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> 分析文档
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">MFGTool initramfs Boot Root Filesystem</a></li>
<li><a class="reference internal" href="#common-command">Common Command</a></li>
<li><a class="reference internal" href="#id1">参考文档：</a></li>
<li><a class="reference internal" href="#u-boot-boot-analysis">U-Boot Boot Analysis</a></li>
<li><a class="reference internal" href="#initramfs-linuxrc-switch-root-to-root-file-system">initramfs linuxrc switch_root to root file system</a></li>
<li><a class="reference internal" href="#support-dm-crypt">Support dm-crypt</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">分析文档</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mfgtool-initramfs-boot-root-filesystem">
<h1>MFGTool initramfs Boot Root Filesystem<a class="headerlink" href="#mfgtool-initramfs-boot-root-filesystem" title="Permalink to this headline"></a></h1>
<p>分析MFGTool的initramfs</p>
</section>
<section id="common-command">
<h1>Common Command<a class="headerlink" href="#common-command" title="Permalink to this headline"></a></h1>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MACHINE=imx6dlsabresd</span> <span class="pre">DISTRO=fsl-imx-x11</span> <span class="pre">source</span> <span class="pre">./fsl-setup-release.sh</span> <span class="pre">-b</span> <span class="pre">imx6q-x11</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bitbake</span> <span class="pre">fsl-image-mfgtool-initramfs</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">setup-environment</span> <span class="pre">imx6q-x11/</span></code></p></li>
</ul>
</section>
<section id="id1">
<h1>参考文档：<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://community.nxp.com/thread/301459">IMX6 - booting to a roofts on ramdisk (Boundary Sabre-lite)?</a></p></li>
<li><p><a class="reference external" href="http://www.compulab.co.il/utilite-computer/wiki/index.php/U-Boot_Scripts">U-Boot Scripts</a></p></li>
<li><p><a class="reference external" href="http://www.iteedu.com/os/linux/mklinuxdiary/ch3initrd/23.php">initramfs切入真实linux文件系统</a></p></li>
<li><p><a class="reference external" href="https://serverfault.com/questions/472683/low-on-space-in-run">Low on space in /run</a></p></li>
<li><p><a class="reference external" href="https://www.cnblogs.com/zengjfgit/p/9323709.html">mount: mounting proc on /proc failed: Device or resource busy</a></p></li>
</ul>
</section>
<section id="u-boot-boot-analysis">
<h1>U-Boot Boot Analysis<a class="headerlink" href="#u-boot-boot-analysis" title="Permalink to this headline"></a></h1>
<ul>
<li><p>MfgTool Boot from RAM file system info</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[...省略]
Boot from USB for mfgtools
Use default environment for                              mfgtools
Run bootcmd_mfg: run mfgtool_args;bootz ${loadaddr} ${initrd_addr} ${fdt_addr};
Hit any key to stop autoboot:  0
Kernel image @ 0x12000000 [ 0x000000 - 0x557d98 ]
## Loading init Ramdisk from Legacy Image at 12c00000 ...
   Image Name:   fsl-image-mfgtool-initramfs-imx6
   Image Type:   ARM Linux RAMDisk Image (gzip compressed)
   Data Size:    7565864 Bytes = 7.2 MiB
   Load Address: 00000000
   Entry Point:  00000000
   Verifying Checksum ... OK
## Flattened Device Tree blob at 18000000
   Booting using the fdt blob at 0x18000000
[...省略]
</pre></div>
</div>
</li>
<li><p>bootz help</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=&gt;</span> <span class="n">help</span> <span class="n">bootz</span>
<span class="n">bootz</span> <span class="o">-</span> <span class="n">boot</span> <span class="n">Linux</span> <span class="n">zImage</span> <span class="n">image</span> <span class="kn">from</span> <span class="nn">memory</span>

<span class="n">Usage</span><span class="p">:</span>
<span class="n">bootz</span> <span class="p">[</span><span class="n">addr</span> <span class="p">[</span><span class="n">initrd</span><span class="p">[:</span><span class="n">size</span><span class="p">]]</span> <span class="p">[</span><span class="n">fdt</span><span class="p">]]</span>
    <span class="o">-</span> <span class="n">boot</span> <span class="n">Linux</span> <span class="n">zImage</span> <span class="n">stored</span> <span class="ow">in</span> <span class="n">memory</span>
        <span class="n">The</span> <span class="n">argument</span> <span class="s1">&#39;initrd&#39;</span> <span class="ow">is</span> <span class="n">optional</span> <span class="ow">and</span> <span class="n">specifies</span> <span class="n">the</span> <span class="n">address</span>
        <span class="n">of</span> <span class="n">the</span> <span class="n">initrd</span> <span class="ow">in</span> <span class="n">memory</span><span class="o">.</span> <span class="n">The</span> <span class="n">optional</span> <span class="n">argument</span> <span class="s1">&#39;:size&#39;</span> <span class="n">allows</span>
        <span class="n">specifying</span> <span class="n">the</span> <span class="n">size</span> <span class="n">of</span> <span class="n">RAW</span> <span class="n">initrd</span><span class="o">.</span>
        <span class="n">When</span> <span class="n">booting</span> <span class="n">a</span> <span class="n">Linux</span> <span class="n">kernel</span> <span class="n">which</span> <span class="n">requires</span> <span class="n">a</span> <span class="n">flat</span> <span class="n">device</span><span class="o">-</span><span class="n">tree</span>
        <span class="n">a</span> <span class="n">third</span> <span class="n">argument</span> <span class="ow">is</span> <span class="n">required</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">address</span> <span class="n">of</span> <span class="n">the</span>
        <span class="n">device</span><span class="o">-</span><span class="n">tree</span> <span class="n">blob</span><span class="o">.</span> <span class="n">To</span> <span class="n">boot</span> <span class="n">that</span> <span class="n">kernel</span> <span class="n">without</span> <span class="n">an</span> <span class="n">initrd</span> <span class="n">image</span><span class="p">,</span>
        <span class="n">use</span> <span class="n">a</span> <span class="s1">&#39;-&#39;</span> <span class="k">for</span> <span class="n">the</span> <span class="n">second</span> <span class="n">argument</span><span class="o">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">do</span> <span class="ow">not</span> <span class="k">pass</span> <span class="n">a</span> <span class="n">third</span>
        <span class="n">a</span> <span class="n">bd_info</span> <span class="n">struct</span> <span class="n">will</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">instead</span>

<span class="o">=&gt;</span>
</pre></div>
</div>
</li>
<li><p>Print all environments</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>=&gt; print
baudrate=115200
board_name=SABRESD
board_rev=MX6DL
boot_fdt=try
bootcmd=run findfdt;mmc dev ${mmcdev};if mmc rescan; then if run loadbootscript; then run bootscript; else if run loadimage; then run mmcboot; else run netboot; fi; fi; else run netboot; fi
bootcmd_mfg=run mfgtool_args;bootz ${loadaddr} ${initrd_addr} ${fdt_addr};
bootdelay=3
bootscript=echo Running bootscript from mmc ...; source
console=ttymxc0
dfu_alt_info=spl raw 0x400
dfu_alt_info_img=u-boot raw 0x10000
dfu_alt_info_spl=spl raw 0x400
dfuspi=dfu 0 sf 0:0:10000000:0
emmcdev=2
epdc_waveform=epdc_splash.bin
ethact=FEC
ethprime=FEC
fdt_addr=0x18000000
fdt_file=undefined
fdt_high=0xffffffff
findfdt=if test $fdt_file = undefined; then if test $board_name = SABREAUTO &amp;&amp; test $board_rev = MX6QP; then setenv fdt_file imx6qp-sabreauto.dtb; fi; if test $board_name = SABREAUTO &amp;&amp; test $board_rev = MX6Q; then setenv fdt_file imx6q-sabreauto.dtb; fi; if test $board_name = SABREAUTO &amp;&amp; test $board_rev = MX6DL; then setenv fdt_file imx6dl-sabreauto.dtb; fi; if test $board_name = SABRESD &amp;&amp; test $board_rev = MX6QP; then setenv fdt_file imx6qp-sabresd.dtb; fi; if test $board_name = SABRESD &amp;&amp; test $board_rev = MX6Q; then setenv fdt_file imx6q-sabresd.dtb; fi; if test $board_name = SABRESD &amp;&amp; test $board_rev = MX6DL; then setenv fdt_file imx6dl-sabresd.dtb; fi; if test $fdt_file = undefined; then echo WARNING: Could not determine dtb to use; fi; fi;
image=zImage
initrd_addr=0x12C00000
initrd_high=0xffffffff
ip_dyn=yes
loadaddr=0x12000000
loadbootscript=fatload mmc ${mmcdev}:${mmcpart} ${loadaddr} ${script};
loadfdt=fatload mmc ${mmcdev}:${mmcpart} ${fdt_addr} ${fdt_file}
loadimage=fatload mmc ${mmcdev}:${mmcpart} ${loadaddr} ${image}
mfgtool_args=setenv bootargs console=ttymxc0,115200 rdinit=/linuxrc g_mass_storage.stall=0 g_mass_storage.removable=1 g_mass_storage.file=/fat g_mass_storage.ro=1 g_mass_storage.idVendor=0x066F g_mass_storage.idProduct=0x37FF g_mass_storage.iSerialNumber=&quot;&quot; enable_wait_mode=off
mmcargs=setenv bootargs console=${console},${baudrate} ${smp} root=${mmcroot}
mmcautodetect=yes
mmcboot=echo Booting from mmc ...; run mmcargs; if test ${boot_fdt} = yes || test ${boot_fdt} = try; then if run loadfdt; then bootz ${loadaddr} - ${fdt_addr}; else if test ${boot_fdt} = try; then bootz; else echo WARN: Cannot load the DT; fi; fi; else bootz; fi;
mmcdev=2
mmcpart=1
mmcroot=/dev/mmcblk3p2 rootwait rw
netargs=setenv bootargs console=${console},${baudrate} ${smp} root=/dev/nfs ip=dhcp nfsroot=${serverip}:${nfsroot},v3,tcp
netboot=echo Booting from net ...; run netargs; if test ${ip_dyn} = yes; then setenv get_cmd dhcp; else setenv get_cmd tftp; fi; ${get_cmd} ${image}; if test ${boot_fdt} = yes || test ${boot_fdt} = try; then if ${get_cmd} ${fdt_addr} ${fdt_file}; then bootz ${loadaddr} - ${fdt_addr}; else if test ${boot_fdt} = try; then bootz; else echo WARN: Cannot load the DT; fi; fi; else bootz; fi;
script=boot.scr
update_emmc_firmware=if test ${ip_dyn} = yes; then setenv get_cmd dhcp; else setenv get_cmd tftp; fi; if ${get_cmd} ${update_sd_firmware_filename}; then if mmc dev ${emmcdev} 1; then setexpr fw_sz ${filesize} / 0x200; setexpr fw_sz ${fw_sz} + 1; mmc write ${loadaddr} 0x2 ${fw_sz}; fi; fi
update_sd_firmware=if test ${ip_dyn} = yes; then setenv get_cmd dhcp; else setenv get_cmd tftp; fi; if mmc dev ${mmcdev}; then if ${get_cmd} ${update_sd_firmware_filename}; then setexpr fw_sz ${filesize} / 0x200; setexpr fw_sz ${fw_sz} + 1; mmc write ${loadaddr} 0x2 ${fw_sz}; fi; fi

Environment size: 3588/8188 bytes
</pre></div>
</div>
</li>
<li><p>Boot with initramfs with manual operation in U-Boot</p>
<ul class="simple">
<li><p>default variable:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">fdt_addr=0x18000000</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">initrd_addr=0x12C00000</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">loadaddr=0x12000000</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">load</span> <span class="pre">mmc</span> <span class="pre">2</span> <span class="pre">$loadaddr</span> <span class="pre">zImage</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">load</span> <span class="pre">mmc</span> <span class="pre">2</span> <span class="pre">$initrd_addr</span> <span class="pre">initramfs</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">load</span> <span class="pre">mmc</span> <span class="pre">2</span> <span class="pre">$fdt_addr</span> <span class="pre">imx6dl-sabresd.dtb</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bootz</span> <span class="pre">$loadaddr</span> <span class="pre">$initrd_addr</span> <span class="pre">$fdt_addr</span></code></p></li>
<li><p>在运行bootz之前，可选项运行条件：<code class="docutils literal notranslate"><span class="pre">setenv</span> <span class="pre">bootargs</span> <span class="pre">console=ttymxc0,115200</span> <span class="pre">rdinit=/linuxrc</span></code></p></li>
</ul>
</li>
</ul>
</section>
<section id="initramfs-linuxrc-switch-root-to-root-file-system">
<h1>initramfs linuxrc switch_root to root file system<a class="headerlink" href="#initramfs-linuxrc-switch-root-to-root-file-system" title="Permalink to this headline"></a></h1>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">~/fsl-release-bsp/imx6q-x11/tmp/work/imx6dlsabresd-poky-linux-gnueabi/fsl-image-mfgtool-initramfs/1.0-r0/rootfs/linuxrc</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="n">export</span> <span class="n">PATH</span><span class="o">=/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span>

<span class="n">mount</span> <span class="o">-</span><span class="n">t</span> <span class="n">devtmpfs</span> <span class="n">none</span> <span class="o">/</span><span class="n">dev</span>
<span class="n">mount</span> <span class="o">-</span><span class="n">t</span> <span class="n">proc</span> <span class="n">none</span> <span class="o">/</span><span class="n">proc</span>
<span class="n">mount</span> <span class="o">-</span><span class="n">t</span> <span class="n">sysfs</span> <span class="n">none</span> <span class="o">/</span><span class="n">sys</span>
<span class="n">mount</span> <span class="o">-</span><span class="n">t</span> <span class="n">tmpfs</span> <span class="n">tmpfs</span> <span class="o">/</span><span class="n">run</span>

<span class="n">sleep</span> <span class="mi">1</span>

<span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk3p2</span> <span class="o">/</span><span class="n">mnt</span>

<span class="c1"># mount --move /dev     /mnt/dev</span>
<span class="c1"># mount --move /proc    /mnt/proc</span>
<span class="c1"># mount --move /sys     /mnt/sys</span>
<span class="c1"># mount --move /run     /mnt/run</span>

<span class="n">echo</span> <span class="s2">&quot;switch_root /mnt /linuxrc&quot;</span>
<span class="n">exec</span> <span class="n">switch_root</span> <span class="o">/</span><span class="n">mnt</span> <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">init</span>
</pre></div>
</div>
</li>
<li><p>recompile</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">target=fsl-image-mfgtool-initramfs</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">setup-environment</span> <span class="pre">imx6q-x11</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bitbake</span> <span class="pre">-f</span> <span class="pre">-c</span> <span class="pre">image_cpio</span> <span class="pre">$target</span></code></p></li>
</ul>
</li>
</ul>
</section>
<section id="support-dm-crypt">
<h1>Support dm-crypt<a class="headerlink" href="#support-dm-crypt" title="Permalink to this headline"></a></h1>
<ul>
<li><p>Work Path: <code class="docutils literal notranslate"><span class="pre">~/fsl-release-bsp/imx6q-x11/tmp/work/imx6dlsabresd-poky-linux-gnueabi/fsl-image-mfgtool-initramfs/1.0-r0</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sources/meta-fsl-arm/recipes-fsl/images/fsl-image-mfgtool-initramfs.bb</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sources/meta-fsl-arm/classes/mfgtool-initramfs-image.bbclass</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Generates a Manufacturing Tool Initramfs image
#
# This generates the initramfs used for the installation process. The
# image provides the utilities which are used, in the target, during
# the process and receive the commands from the MfgTool application.
#
# Copyright 2014, 2016 (C) O.S. Systems Software LTDA.

DEPENDS += &quot;u-boot-mfgtool linux-mfgtool&quot;

FEATURE_PACKAGES_mtd = &quot;packagegroup-fsl-mfgtool-mtd&quot;
FEATURE_PACKAGES_extfs = &quot;packagegroup-fsl-mfgtool-extfs&quot;
FEATURE_PACKAGES_f2fs = &quot;packagegroup-fsl-mfgtool-f2fs&quot;

IMAGE_FSTYPES = &quot;cpio.gz.u-boot&quot;
IMAGE_FSTYPES_mxs = &quot;cpio.gz.u-boot&quot;
IMAGE_ROOTFS_SIZE ?= &quot;8192&quot;
IMAGE_CLASSES = &quot;image_types_uboot&quot;

# Filesystems enabled by default
DEFAULT_FS_SUPPORT = &quot; \
    mtd \
    extfs \
&quot;

IMAGE_INSTALL += &quot;cryptsetup&quot;         # add cryptsetup support

IMAGE_FEATURES = &quot; \
    ${DEFAULT_FS_SUPPORT} \
    \
    read-only-rootfs \
&quot;

# Avoid installation of syslog
BAD_RECOMMENDATIONS += &quot;busybox-syslog&quot;

# Avoid static /dev
USE_DEVFS = &quot;1&quot;

inherit core-image

CORE_IMAGE_BASE_INSTALL = &quot; \
    ${CORE_IMAGE_EXTRA_INSTALL} \
&quot;
</pre></div>
</div>
</li>
<li><p>recompile</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">target=fsl-image-mfgtool-initramfs</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">setup-environment</span> <span class="pre">imx6q-x11</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bitbake</span> <span class="pre">$target</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bitbake</span> <span class="pre">-f</span> <span class="pre">-c</span> <span class="pre">image_cpio</span> <span class="pre">$target</span></code></p></li>
</ul>
</li>
</ul>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, zengjf.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JjOE14XScyd75b2C",ck: "JjOE14XScyd75b2C"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JjOE14XScyd75b2C/quote.js?theme=0&f=12&display=1,0,0,0,0,0,1,1"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>