# lxc devices cgroup mount

查看devices cgroup可否自己手动mount

# 参考文档

* [Cgroups /sys/fs/cgroup is empty on ubuntu](https://stackoverflow.com/questions/27454848/cgroups-sys-fs-cgroup-is-empty-on-ubuntu)
* https://www.kernel.org/doc/Documentation/cgroup-v1/cgroups.txt

# 默认挂载情况

* findmnt
  ```
  TARGET                           SOURCE         FSTYPE      OPTIONS
  /                                /dev/mmcblk0p2 ext4        rw,noatime
  ├─/dev                           devtmpfs       devtmpfs    rw,relatime,size=3946496k,nr_inodes=108545,mode=755
  │ ├─/dev/shm                     tmpfs          tmpfs       rw,nosuid,nodev
  │ ├─/dev/pts                     devpts         devpts      rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000
  │ └─/dev/mqueue                  mqueue         mqueue      rw,relatime
  ├─/sys                           sysfs          sysfs       rw,nosuid,nodev,noexec,relatime
  │ ├─/sys/kernel/security         securityfs     securityfs  rw,nosuid,nodev,noexec,relatime
  │ ├─/sys/fs/cgroup               tmpfs          tmpfs       ro,nosuid,nodev,noexec,mode=755
  │ │ ├─/sys/fs/cgroup/unified     cgroup2        cgroup2     rw,nosuid,nodev,noexec,relatime
  │ │ ├─/sys/fs/cgroup/systemd     cgroup         cgroup      rw,nosuid,nodev,noexec,relatime,xattr,name=systemd
  │ │ ├─/sys/fs/cgroup/net_cls     cgroup         cgroup      rw,nosuid,nodev,noexec,relatime,net_cls
  │ │ ├─/sys/fs/cgroup/cpuset      cgroup         cgroup      rw,nosuid,nodev,noexec,relatime,cpuset,clone_children
  │ │ ├─/sys/fs/cgroup/cpu,cpuacct cgroup         cgroup      rw,nosuid,nodev,noexec,relatime,cpu,cpuacct
  │ │ ├─/sys/fs/cgroup/devices     cgroup         cgroup      rw,nosuid,nodev,noexec,relatime,devices
  │ │ ├─/sys/fs/cgroup/pids        cgroup         cgroup      rw,nosuid,nodev,noexec,relatime,pids
  │ │ ├─/sys/fs/cgroup/freezer     cgroup         cgroup      rw,nosuid,nodev,noexec,relatime,freezer
  │ │ ├─/sys/fs/cgroup/blkio       cgroup         cgroup      rw,nosuid,nodev,noexec,relatime,blkio
  │ │ └─/sys/fs/cgroup/memory      cgroup         cgroup      rw,nosuid,nodev,noexec,relatime,memory
  │ ├─/sys/fs/bpf                  bpf            bpf         rw,nosuid,nodev,noexec,relatime,mode=700
  │ ├─/sys/kernel/debug            debugfs        debugfs     rw,relatime
  │ ├─/sys/kernel/config           configfs       configfs    rw,relatime
  │ └─/sys/fs/fuse/connections     fusectl        fusectl     rw,relatime
  ├─/proc                          proc           proc        rw,relatime
  │ └─/proc/sys/fs/binfmt_misc     systemd-1      autofs      rw,relatime,fd=28,pgrp=1,timeout=0,minproto=5,maxproto=5,direct
  │   └─/proc/sys/fs/binfmt_misc   binfmt_misc    binfmt_misc rw,relatime
  ├─/run                           tmpfs          tmpfs       rw,nosuid,nodev,mode=755
  │ ├─/run/lock                    tmpfs          tmpfs       rw,nosuid,nodev,noexec,relatime,size=5120k
  │ ├─/run/rpc_pipefs              sunrpc         rpc_pipefs  rw,relatime
  │ ├─/run/user/110                tmpfs          tmpfs       rw,nosuid,nodev,relatime,size=815716k,mode=700,uid=110,gid=118
  │ └─/run/user/1000               tmpfs          tmpfs       rw,nosuid,nodev,relatime,size=815716k,mode=700,uid=1000,gid=1000
  ├─/snap/core18/1948              /dev/loop0     squashfs    ro,nodev,relatime
  ├─/snap/core/10827               /dev/loop1     squashfs    ro,nodev,relatime
  ├─/snap/core/10584               /dev/loop2     squashfs    ro,nodev,relatime
  ├─/snap/core18/1989              /dev/loop3     squashfs    ro,nodev,relatime
  ├─/boot                          /dev/mmcblk0p1 vfat        rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=ascii,shortname=mixed,errors=remount-ro
  └─/var/lib/lxcfs                 lxcfs          fuse.lxcfs  rw,nosuid,nodev,relatime,user_id=0,group_id=0,allow_other
  ```
* cat /proc/self/mountinfo

# 手动挂载

* devices
  ```
  /sys/fs/cgroup/devices     cgroup         cgroup      rw,nosuid,nodev,noexec,relatime,devices
  ```
* 参考文档：[Cgroup v1 named hierarchies](https://man7.org/linux/man-pages/man7/cgroups.7.html)
* sudo su
* mkdir /dev/devices
* mount -t cgroup -o rw,nosuid,nodev,noexec,relatime,devices cgroup /dev/devices
* findmnt
  ```
  TARGET                           SOURCE         FSTYPE      OPTIONS
  # ...省略
  ├─/boot                          /dev/mmcblk0p1 vfat        rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=ascii,shortname=mixed,errors=remount-ro
  ├─/var/lib/lxcfs                 lxcfs          fuse.lxcfs  rw,nosuid,nodev,relatime,user_id=0,group_id=0,allow_other
  └─/devices                       cgroup         cgroup      rw,nosuid,nodev,noexec,relatime,devices
  ```
* cat /proc/cgroups
  ```
  #subsys_name    hierarchy       num_cgroups     enabled
  cpuset  3       6       1
  cpu     1       1       1
  cpuacct 2       179     1
  schedtune       5       6       1
  memory  4       3       1
  devices 0       1       1
  freezer 0       1       1
  debug   0       1       1
  ```
* https://android.googlesource.com/kernel/common/+/android-3.18/Documentation/cgroups/devices.txt
* /sys/fs/cgroup/devices/lxc/zengjf
  * 相当于先mkdir创建lxc，再在lxc中mkdir创建zengjf，内核会自动生成对应的文件

# Android添加设备节点失败

* lxc-device程序中固定了挂载点都在`/sys/fs/cgroup/`，
  * https://github.com/ZengjfOS/lxc-android/blob/lxc-3.0.3-android-28/src/lxc/cgroups/cgfsng.c#L724
    * cg_hybrid_get_controllers()
* lxc-start -n zengjf -l TRACE -o lxc.log
* lxc-device -n zengjf -l TRACE -o lxc.log add /dev/binder
  * 如上可知，所以该程序如果在Android下会找不到`cgroup hierarchies`：
    ```
    TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1047 - basecginfo is:
    TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1048 - 6:devices:/
    5:schedtune:/
    4:memory:/
    3:cpuset:/
    2:cpuacct:/
    1:cpu:/
    0::/
    TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1051 - kernel subsystem 0: devices
    TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1051 - kernel subsystem 1: schedtune
    TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1051 - kernel subsystem 2: memory
    TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1051 - kernel subsystem 3: cpuset
    TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1051 - kernel subsystem 4: cpuacct
    TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1051 - kernel subsystem 5: cpu
    TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1051 - kernel subsystem 6: cgroup2
    WARN     cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_get_controllers:746 - Found hierarchy not under /sys/fs/cgroup: "/dev/cg2_bpf rw,nosuid,nodev,noexec,relatime shared:9 - cgroup2 none rw
    TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_init:2450 - No controllers are enabled for delegation in the unified hierarchy
    WARN     cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_get_controllers:746 - Found hierarchy not under /sys/fs/cgroup: "/dev/cpuctl rw,nosuid,nodev,noexec,relatime shared:17 - cgroup none rw,cpu
    WARN     cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_get_controllers:746 - Found hierarchy not under /sys/fs/cgroup: "/acct rw,nosuid,nodev,noexec,relatime shared:18 - cgroup none rw,cpuacct
    WARN     cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_get_controllers:746 - Found hierarchy not under /sys/fs/cgroup: "/dev/cpuset rw,nosuid,nodev,noexec,relatime shared:19 - cgroup none rw,cpuset,noprefix,release_agent=/sbin/cpuset_release_agent
    WARN     cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_get_controllers:746 - Found hierarchy not under /sys/fs/cgroup: "/dev/memcg rw,nosuid,nodev,noexec,relatime shared:20 - cgroup none rw,memory
    WARN     cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_get_controllers:746 - Found hierarchy not under /sys/fs/cgroup: "/dev/stune rw,nosuid,nodev,noexec,relatime shared:21 - cgroup none rw,schedtune
    WARN     cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_get_controllers:746 - Found hierarchy not under /sys/fs/cgroup: "/dev/devices rw,nosuid,nodev,noexec,relatime shared:37 - cgroup cgroup rw,devices
    TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_init:2478 - Writable cgroup hierarchies:
    TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_hierarchies:1028 -   Hierarchies:
    TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_hierarchies:1033 -   0: base_cgroup: /
    TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_hierarchies:1034 -       mountpoint:  /dev/cg2_bpf
    TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_hierarchies:1035 -       controllers:
    ```
* 参考文档：
  * [Cgroups /sys/fs/cgroup is empty on ubuntu](https://stackoverflow.com/questions/27454848/cgroups-sys-fs-cgroup-is-empty-on-ubuntu)
  * https://www.kernel.org/doc/Documentation/cgroup-v1/cgroups.txt
    * 1.6 How do I use cgroups ?
* 挂载devices
  * mount -t tmpfs cgroup_root /sys/fs/cgroup
  * mkdir /sys/fs/cgroup/devices
  * mount -t cgroup -o devices devices /sys/fs/cgroup/devices
* lxc-device -n zengjf -l TRACE -o lxc.log add /dev/binder
  ```
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1047 - basecginfo is:
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1048 - 6:devices:/
  5:schedtune:/
  4:memory:/
  3:cpuset:/
  2:cpuacct:/
  1:cpu:/
  0::/
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1051 - kernel subsystem 0: devices
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1051 - kernel subsystem 1: schedtune
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1051 - kernel subsystem 2: memory
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1051 - kernel subsystem 3: cpuset
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1051 - kernel subsystem 4: cpuacct
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1051 - kernel subsystem 5: cpu
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_basecg_debuginfo:1051 - kernel subsystem 6: cgroup2
  WARN     cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_get_controllers:746 - Found hierarchy not under /sys/fs/cgroup: "/dev/cg2_bpf rw,nosuid,nodev,noexec,relatime shared:9 - cgroup2 none rw
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_init:2451 - No controllers are enabled for delegation in the unified hierarchy
  WARN     cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_get_controllers:746 - Found hierarchy not under /sys/fs/cgroup: "/dev/cpuctl rw,nosuid,nodev,noexec,relatime shared:17 - cgroup none rw,cpu
  WARN     cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_get_controllers:746 - Found hierarchy not under /sys/fs/cgroup: "/acct rw,nosuid,nodev,noexec,relatime shared:18 - cgroup none rw,cpuacct
  WARN     cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_get_controllers:746 - Found hierarchy not under /sys/fs/cgroup: "/dev/cpuset rw,nosuid,nodev,noexec,relatime shared:19 - cgroup none rw,cpuset,noprefix,release_agent=/sbin/cpuset_release_agent
  WARN     cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_get_controllers:746 - Found hierarchy not under /sys/fs/cgroup: "/dev/memcg rw,nosuid,nodev,noexec,relatime shared:20 - cgroup none rw,memory
  WARN     cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_get_controllers:746 - Found hierarchy not under /sys/fs/cgroup: "/dev/stune rw,nosuid,nodev,noexec,relatime shared:21 - cgroup none rw,schedtune
  WARN     cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_get_controllers:746 - Found hierarchy not under /sys/fs/cgroup: "/dev/devices rw,nosuid,nodev,noexec,relatime shared:37 - cgroup cgroup rw,devices
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cg_hybrid_init:2479 - Writable cgroup hierarchies:
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_hierarchies:1028 -   Hierarchies:
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_hierarchies:1033 -   0: base_cgroup: /
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_hierarchies:1034 -       mountpoint:  /dev/cg2_bpf
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_hierarchies:1035 -       controllers:
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_hierarchies:1033 -   1: base_cgroup: /
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_hierarchies:1034 -       mountpoint:  /sys/fs/cgroup/cpuset
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_hierarchies:1035 -       controllers:
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_hierarchies:1037 -       0: cpuset
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_hierarchies:1033 -   2: base_cgroup: /
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_hierarchies:1034 -       mountpoint:  /sys/fs/cgroup/devices
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_hierarchies:1035 -       controllers:
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:lxc_cgfsng_print_hierarchies:1037 -       0: devices
  TRACE    cgroup - external/lxc-android/src/lxc/cgroups/cgroup.c:cgroup_init:56 - Initialized cgroup driver cgfsng
  TRACE    cgroup - external/lxc-android/src/lxc/cgroups/cgroup.c:cgroup_init:61 - Running with hybrid cgroup layout
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cgfsng_set:2072 - cgfsng_set: file name: devices.allow
  TRACE    commands - external/lxc-android/src/lxc/commands.c:lxc_cmd_rsp_recv:139 - Command "get_cgroup" received response
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cgfsng_set:2079 - cgfsng_set: path: //lxc/zengjf
  TRACE    cgfsng - external/lxc-android/src/lxc/cgroups/cgfsng.c:cgfsng_set:2080 - cgfsng_set: lxcpath: /data/lxc/containers
  ```
